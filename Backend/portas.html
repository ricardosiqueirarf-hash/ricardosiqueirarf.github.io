<!DOCTYPE html>
<html lang="pt-br">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Portas de Vidro e Alum√≠nio em Fortaleza | ColorGlass</title>
<meta name="description" content="Portas de vidro e alum√≠nio sob medida em Fortaleza. Or√ßamento r√°pido, qualidade premium e instala√ß√£o profissional.">
<meta name="robots" content="index, follow">

<!-- SEO LOCAL -->
<meta name="geo.region" content="BR-CE">
<meta name="geo.placename" content="Fortaleza">
<meta name="geo.position" content="-3.7319;-38.5267">
<meta name="ICBM" content="-3.7319, -38.5267">

<!-- CANONICAL -->
<link rel="canonical" href="https://www.colorglassfortaleza.com.br/">

<!-- OPEN GRAPH -->
<meta property="og:title" content="Portas de Vidro e Alum√≠nio em Fortaleza | ColorGlass">
<meta property="og:description" content="Or√ßamento r√°pido em portas de vidro e alum√≠nio sob medida em Fortaleza. Qualidade premium e instala√ß√£o profissional.">
<meta property="og:url" content="https://www.colorglassfortaleza.com.br/">
<meta property="og:type" content="website">

<style>
/* =========================
   EST√âTICA NOVA (login/aprovacao-like)
   ‚ö†Ô∏è N√ÉO MEXE EM MEC√ÇNICA
   ========================= */

:root {
  --cg-blue: #1079ba;
  --cg-blue-dark: #0d5d8c;
  --cg-blue-soft: #e7f3fb;
  --cg-gold: #f0c24c;
  --cg-white: #ffffff;
  --cg-text: #1f2933;
  --cg-muted: #6b7280;
  --cg-border: rgba(16, 121, 186, 0.12);
  --cg-shadow: 0 12px 30px rgba(15, 44, 62, 0.12);
  --cg-shadow-soft: 0 10px 24px rgba(15, 44, 62, 0.10);
}

/* RESET B√ÅSICO */
* { box-sizing: border-box; margin:0; padding:0; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; }

/* FUNDO padr√£o */
body {
  background:
    radial-gradient(circle at top, rgba(16,121,186,0.15), transparent 55%),
    linear-gradient(135deg, #f5fbff 0%, #eef4f9 45%, #f8fbff 100%);
  color: var(--cg-text);
  min-height: 100vh;
}

/* APP GRID */
.app {
  display: grid;
  grid-template-columns: 240px 1fr;
  min-height: 100vh;
  gap: 18px;
  padding: 18px;
  animation: fadeIn 0.75s ease;
}

/* SIDEBAR (card) */
.sidebar {
  background: linear-gradient(135deg, var(--cg-blue), var(--cg-blue-dark));
  color: #fff;
  padding: 22px 18px;
  display: flex;
  flex-direction: column;
  gap: 12px;
  border-radius: 18px;
  box-shadow: var(--cg-shadow);
  position: sticky;
  top: 18px;
  height: calc(100vh - 36px);
  overflow: hidden;
  transition: transform 0.25s ease, box-shadow 0.25s ease;
}

.sidebar::after{
  content:"";
  position:absolute;
  right:-90px;
  top:-120px;
  width:260px;
  height:260px;
  background: radial-gradient(circle, rgba(255,255,255,0.22), transparent 60%);
  pointer-events:none;
}

.sidebar h3 {
  margin-bottom: 8px;
  font-size: 1.25rem;
  letter-spacing: 0.6px;
  position: relative;
  z-index: 1;
}

.sidebar button {
  padding: 12px 12px;
  border: 1px solid rgba(255,255,255,0.18);
  border-radius: 12px;
  background: rgba(255,255,255,0.14);
  color: #fff;
  cursor: pointer;
  text-align: left;
  font-weight: 700;
  transition: transform 0.2s ease, background 0.2s ease, box-shadow 0.2s ease;
  position: relative;
  z-index: 1;
}

.sidebar button:hover {
  background: rgba(255,255,255,0.22);
  transform: translateX(4px);
  box-shadow: 0 10px 18px rgba(0,0,0,0.14);
}

/* CONTENT (glass card) */
.content {
  padding: 22px;
  overflow-y: auto;
  border-radius: 18px;
  background: rgba(255,255,255,0.55);
  border: 1px solid rgba(16,121,186,0.10);
  box-shadow: var(--cg-shadow-soft);
  backdrop-filter: blur(10px);
  animation: floatIn 0.65s ease;
}

.content h1 {
  color: var(--cg-blue-dark);
  margin-bottom: 10px;
  font-size: 1.65rem;
}
.content h2{
  color: var(--cg-blue);
  margin-bottom: 10px;
  font-size: 1.15rem;
}

/* Info or√ßamento */
#infoOrcamento{
  background: var(--cg-white);
  border: 1px solid var(--cg-border);
  box-shadow: var(--cg-shadow-soft);
  border-radius: 16px;
  padding: 14px 16px;
  margin-bottom: 14px;
  position: relative;
  overflow: hidden;
}

#infoOrcamento::before{
  content:"";
  position:absolute;
  inset:0;
  background: linear-gradient(120deg, rgba(16,121,186,0.10), transparent 55%);
  opacity: 0.0;
  transition: opacity 0.25s ease;
  pointer-events:none;
}
#infoOrcamento:hover::before{ opacity: 1; }

/* Layout principal */
.door-layout {
  display: grid;
  grid-template-columns: minmax(280px, 460px) 1fr;
  gap: 18px;
  align-items: start;
  margin-top: 10px;
}

/* Cards */
.door-form,
.door-preview,
.section-card{
  background: var(--cg-white);
  border-radius: 18px;
  border: 1px solid var(--cg-border);
  box-shadow: var(--cg-shadow);
  position: relative;
  overflow: hidden;
  animation: cardIn 0.6s ease;
}

.door-form::before,
.door-preview::before,
.section-card::before{
  content:"";
  position:absolute;
  inset:0;
  background: linear-gradient(120deg, rgba(16,121,186,0.08), transparent 55%);
  opacity: 0;
  transition: opacity 0.25s ease;
  pointer-events:none;
}
.door-form:hover::before,
.door-preview:hover::before,
.section-card:hover::before{ opacity: 1; }

.door-form{
  display: flex;
  flex-direction: column;
  gap: 12px;
  padding: 18px;
  transition: transform 0.25s ease, box-shadow 0.25s ease;
}
.door-preview{
  padding: 12px;
  transition: transform 0.25s ease, box-shadow 0.25s ease;
}
.section-card{
  padding: 16px;
  margin-top: 18px;
  transition: transform 0.25s ease, box-shadow 0.25s ease;
}

.door-form:hover,
.door-preview:hover,
.section-card:hover{
  transform: translateY(-2px);
  box-shadow: 0 16px 36px rgba(15,44,62,0.14);
}

/* Inputs */
label { display:flex; flex-direction:column; font-size:0.92rem; gap:7px; color:#374151; }
input, select, textarea{
  padding: 12px 14px;
  font-size: 0.95rem;
  border-radius: 12px;
  border: 1px solid #d4d9df;
  width: 100%;
  background: #fdfefe;
  transition: border .2s ease, box-shadow .2s ease, transform .15s ease;
}
input:focus, select:focus, textarea:focus{
  border-color: var(--cg-blue);
  box-shadow: 0 0 0 3px rgba(16,121,186,0.15);
  outline: none;
}
input:hover, select:hover, textarea:hover{
  transform: translateY(-1px);
}

/* Required highlight (mant√©m l√≥gica existente) */
.required-empty {
  background: #fdeaea !important;
  border-color: #f1b0b0 !important;
}
.required-filled {
  background: #e9f8ee !important;
  border-color: #9fd4b1 !important;
}

/* Bot√µes */
.btn{
  padding: 12px 16px;
  border: none;
  border-radius: 12px;
  cursor: pointer;
  background: linear-gradient(135deg, var(--cg-blue), var(--cg-blue-dark));
  color: #fff;
  font-weight: 800;
  transition: transform .2s ease, box-shadow .2s ease, opacity .2s ease;
  box-shadow: 0 10px 18px rgba(16,121,186,0.22);
}
.btn:hover{
  transform: translateY(-2px);
  box-shadow: 0 14px 24px rgba(16,121,186,0.26);
}
.btn:active{ transform: translateY(0); }
.btn-danger{
  background: linear-gradient(135deg, #e84118, #c23616);
  box-shadow: 0 10px 18px rgba(226, 73, 33, 0.20);
}
.btn-danger:hover{
  box-shadow: 0 14px 24px rgba(226, 73, 33, 0.26);
}

/* SVG preview */
#portaSVG{
  width: 100%;
  height: 400px;
  border: 1px solid rgba(16,121,186,0.18);
  background: rgba(255,255,255,0.95);
  border-radius: 14px;
}

/* Price preview */
.price-preview{
  background: linear-gradient(135deg, rgba(16,121,186,0.10), rgba(13,93,140,0.04));
  color: var(--cg-blue-dark);
  font-weight: 800;
  padding: 10px 12px;
  border-radius: 14px;
  border: 1px solid rgba(16,121,186,0.14);
}

/* Cost toggle/details */
.cost-toggle{
  display: flex;
  align-items: center;
  gap: 10px;
  font-size: 0.92rem;
  color: #374151;
}
.cost-toggle input[type="checkbox"]{
  width: 18px;
  height: 18px;
  transform: translateY(1px);
}

.cost-details{
  background: rgba(255,255,255,0.92);
  border-radius: 14px;
  padding: 12px;
  box-shadow: 0 10px 18px rgba(15,44,62,0.10);
  font-size: 0.9rem;
  border: 1px solid rgba(16,121,186,0.12);
}

.cost-details table{
  width: 100%;
  border-collapse: collapse;
  margin-top: 8px;
  overflow: hidden;
  border-radius: 12px;
}

.cost-details th,
.cost-details td{
  border: 1px solid rgba(220,221,225,0.85);
  padding: 8px;
  text-align: left;
}

cost-details th{
  background: rgba(231,243,251,0.9);
}

/* Cards internos */
#portasSalvas div,
#printResumo .print-item,
#printOrdem .print-item{
  margin-bottom: 12px;
  border: 1px solid rgba(16,121,186,0.14);
  padding: 12px;
  background: rgba(255,255,255,0.95);
  border-radius: 14px;
  box-shadow: 0 10px 18px rgba(15,44,62,0.08);
  transition: transform .2s ease, box-shadow .2s ease;
}
#portasSalvas div:hover,
#printResumo .print-item:hover,
#printOrdem .print-item:hover{
  transform: translateY(-2px);
  box-shadow: 0 14px 24px rgba(15,44,62,0.12);
}

#estruturas3DSalvas > div{
  margin-bottom: 10px;
  border: 1px solid rgba(16,121,186,0.14);
  padding: 12px;
  background: rgba(247,249,252,0.95);
  border-radius: 14px;
  box-shadow: 0 10px 18px rgba(15,44,62,0.08);
  transition: transform .2s ease, box-shadow .2s ease;
}
#estruturas3DSalvas > div:hover{
  transform: translateY(-2px);
  box-shadow: 0 14px 24px rgba(15,44,62,0.12);
}

/* Print areas */
.print-area { display: none; }
.print-area.active { display: block; }
.thermal-area { display: none; }
.thermal-area.active { display: block; }
#printResumo svg { display: none; }

/* Ordem produ√ß√£o */
.op-svg { border: 1px solid rgba(16,121,186,0.14); border-radius: 14px; background: #fff; width: 100%; height: auto; margin-top: 10px; }
.op-page { display: grid; grid-template-columns: 2fr 1fr; gap: 20px; align-items: center; margin-bottom: 24px; }
.op-info { font-size: 20px; line-height: 1.6; }
.op-quantity { font-size: 28px; font-weight: 700; fill: var(--cg-blue-dark); }
.op-measure { font-size: 20px; fill: #333; }

/* Etiqueta t√©rmica (mantida) */
.thermal-label {
  width: 100mm;
  height: 150mm;
  padding: 6mm;
  border: 1px solid #333;
  box-sizing: border-box;
  font-size: 12px;
  display: flex;
  flex-direction: column;
  justify-content: space-between;
  gap: 6px;
}
.thermal-header { font-size: 20px; line-height: 1.4; }
.thermal-header strong { font-size: 20px; }
.thermal-divider { border-top: 1px solid #333; margin: 4px 0; }
.thermal-body { font-size: 20px; line-height: 1.4; }
.thermal-footer { text-align: center; font-size: 20px; }

.helper-text { color: var(--cg-muted); font-size: 0.85rem; }

/* Scrollbars */
.content::-webkit-scrollbar { width: 10px; }
.content::-webkit-scrollbar-thumb { background: var(--cg-blue); border-radius: 999px; }
.content::-webkit-scrollbar-track { background: rgba(255,255,255,0.0); }

/* PRINT mant√©m a regra original, s√≥ n√£o muda mec√¢nica */
@media print {
  body { background: #fff; }
  .sidebar, .door-form, .door-preview, .section-card, .btn { display: none !important; }
  .print-area.active, .thermal-area.active { display: block; }
  .content { padding: 0; box-shadow: none; border: none; background: #fff; }
  .op-page { page-break-after: always; }
  .thermal-label { page-break-after: always; border: none; }
  #printResumo svg { display: none !important; }
}

/* Responsivo */
@media (max-width: 1024px) {
  .app { grid-template-columns: 1fr; }
  .sidebar {
    position: relative;
    top: 0;
    height: auto;
    flex-direction: row;
    flex-wrap: wrap;
    align-items: center;
    justify-content: space-between;
  }
  .sidebar button { text-align: center; flex: 1; }
  .door-layout { grid-template-columns: 1fr; }
}

/* Anima√ß√µes */
@keyframes fadeIn {
  from { opacity: 0; transform: translateY(10px); }
  to { opacity: 1; transform: translateY(0); }
}
@keyframes floatIn {
  from { opacity: 0; transform: translateY(14px); }
  to { opacity: 1; transform: translateY(0); }
}
@keyframes cardIn {
  from { opacity: 0; transform: translateY(10px); }
  to { opacity: 1; transform: translateY(0); }
}
</style>

<link id="tema-css" rel="stylesheet" href="">
<script>
if(localStorage.getItem("darkmode") === "true"){
    document.getElementById("tema-css").href = "/static/css/indexdark.css";
}
</script>
</head>

<body>
<div class="app">
    <div class="sidebar">
        <h3>ColorGlass</h3>
        <button onclick="go('index_loja.html')">Voltar</button>
    </div>

    <div class="content">
        <h1>Or√ßamento de Portas</h1>

        <div id="infoOrcamento"></div>

        <div class="door-layout">
            <div class="door-form">
                <label>Tipologia
                    <select id="tipologia" onchange="renderCampos()">
                        <option value="">Selecione</option>
                        <option value="giro">Giro</option>
                        <option value="deslizante">Deslizante</option>
                        <option value="correr">Correr</option>
                        <option value="pivotante">Pivotante</option>
                    </select>
                </label>

                <button class="btn" onclick="abrirEstrutura3D()">
                    üß± Or√ßar Estrutura 3D
                </button>

                <label>Quantidade
                    <input type="number" id="quantidade" value="1" min="1" data-required="true" onchange="atualizarPrecoPorta(); atualizarCamposObrigatorios()">
                </label>

                <div id="campos"></div>
                <div class="price-preview" id="precoPorta">Pre√ßo estimado: R$ 0,00</div>
                <label class="cost-toggle">
                    <input type="checkbox" id="toggleCustos" onchange="toggleDetalhesCustos()">
                    Mostrar custos e pre√ßos detalhados
                </label>
                <div class="cost-details" id="detalhesCustos" style="display: none;"></div>
                <button class="btn" onclick="salvarPorta()">Salvar Porta</button>
            </div>

            <div class="door-preview">
                <svg id="portaSVG"></svg>
            </div>
        </div>

        <div class="section-card">
            <h2>Portas Salvas</h2>
            <div id="portasSalvas"></div>
            <div style="display:flex; gap:10px; flex-wrap: wrap;">
                <button class="btn" onclick="imprimirOrcamento()">Imprimir Or√ßamento</button>
                <button class="btn" onclick="imprimirOrdemProducao()">Imprimir Ordem de Produ√ß√£o</button>
                <button class="btn" onclick="imprimirEtiquetaTermica()">Etiqueta t√©rmica</button>
            </div>
        </div>

        <div class="section-card">
            <h2>Estruturas 3D Salvas</h2>
            <div id="estruturas3DSalvas"></div>
        </div>

        <div id="printResumo" class="print-area"></div>
        <div id="printOrdem" class="print-area"></div>
        <div id="printEtiqueta" class="thermal-area"></div>
    </div>
</div>

<script>
function go(p){ window.location.href = p }

// =====================
// BACKEND
// =====================
const API_BASE = "https://colorglass.onrender.com";

function authHeader() {
    const token = localStorage.getItem("ADMIN_TOKEN");
    return token ? { "Authorization": "Bearer " + token } : {};
}

// =====================
// UUID DO OR√áAMENTO
// =====================
const params = new URLSearchParams(window.location.search)
const ORCAMENTO_UUID = params.get("orcamento_uuid")
let orcamentoInfo = { cliente_nome: null, numero_pedido: null }
if(!ORCAMENTO_UUID){
    document.getElementById("infoOrcamento").innerHTML =
        "<strong style='color:red'>UUID do or√ßamento n√£o encontrado</strong>"
    throw new Error("orcamento_uuid ausente")
}
document.getElementById("infoOrcamento").innerHTML =
    `Editando or√ßamento: <strong>${ORCAMENTO_UUID}</strong>`

// =====================
// TIPOLOGIAS
// =====================
const TIPOLOGIAS = {
    giro: ["largura","altura","perfil","vidro","dobradicas","dobradicas_alturas","puxador","altura_puxador","medida_puxador","valor_adicional","puxadores","acessorio","observacao_venda","observacao_producao"],
    deslizante: ["largura","altura","perfil","vidro","trilho","dobradicas","dobradicas_alturas","puxador","altura_puxador","medida_puxador","valor_adicional","puxadores","acessorio","observacao_venda","observacao_producao"],
    correr: ["largura","altura","perfil","vidro","trilho","dobradicas","dobradicas_alturas","puxador","altura_puxador","medida_puxador","valor_adicional","puxadores","acessorio","observacao_venda","observacao_producao"],
    pivotante: ["largura","altura","perfil","vidro","pivo","dobradicas","dobradicas_alturas","puxador","altura_puxador","medida_puxador","valor_adicional","puxadores","acessorio","observacao_venda","observacao_producao"]
}

// =====================
// DADOS
// =====================
let todosPerfis = []
let todosVidros = []
let todosInsumos = []
let todosPuxadores = []
let todasTags = []

async function carregarPerfis() {
    const res = await fetch(`${API_BASE}/api/perfis`)
    todosPerfis = await res.json()
    atualizarPerfisSelect()
}

async function carregarVidros() {
    const res = await fetch(`${API_BASE}/api/vidros`)
    todosVidros = await res.json()
    atualizarVidrosSelect()
}

async function carregarInsumos() {
    const res = await fetch(`${API_BASE}/api/materiais`)
    todosInsumos = await res.json()
    atualizarDetalhesCusto()
}

async function carregarPuxadores() {
    const res = await fetch(`${API_BASE}/api/puxadores`, { headers: authHeader() })
    todosPuxadores = await res.json()
    atualizarPuxadoresSelect()
}

async function carregarTags() {
    const res = await fetch(`${API_BASE}/api/tags`)
    todasTags = await res.json()
    atualizarPrecoPorta()
}

function atualizarPerfisSelect() {
    const tipo = document.getElementById("tipologia").value
    const perfilSelect = document.getElementById("perfil")
    if(!perfilSelect) return
    perfilSelect.innerHTML = "<option value=''>Selecione</option>"
    todosPerfis.filter(p => p.tipologias.includes(tipo))
        .forEach(p => {
            perfilSelect.innerHTML += `<option value="${p.id}">${p.nome}</option>`
        })
}

function atualizarVidrosSelect() {
    const vidroSelect = document.getElementById("vidro")
    if(!vidroSelect) return
    vidroSelect.innerHTML = "<option value=''>Selecione</option>"
    todosVidros.forEach(v => {
        const espessura = v.espessura ? `${v.espessura}mm` : ""
        vidroSelect.innerHTML += `<option value="${v.id}">${[v.tipo, espessura].filter(Boolean).join(" ")}</option>`
    })
}

function atualizarPuxadoresSelect() {
    const puxadorSelect = document.getElementById("puxador")
    if(!puxadorSelect) return
    puxadorSelect.innerHTML = "<option value=''>Selecione</option>"
    puxadorSelect.innerHTML += "<option value='sem_puxador'>Sem puxador</option>"
    todosPuxadores.forEach(p => {
        const unidade = p.tipo_medida === "metro_linear" ? "m" : "un"
        puxadorSelect.innerHTML += `<option value="${p.id}">${p.nome} - R$ ${p.preco}/${unidade}</option>`
    })
}

// =====================
// PRE√áO
// =====================
function obterDadosPuxador() {
    const puxadorId = document.getElementById("puxador")?.value
    if (puxadorId === "sem_puxador") return null
    const puxador = todosPuxadores.find(p => p.id == puxadorId)
    if (!puxador) return null

    const tipoMedida = puxador.tipo_medida
    const quantidadePortas = +document.getElementById("quantidade")?.value || 1
    const medidaPuxadorMm = +document.getElementById("medida_puxador")?.value || 0

    let quantidade = 0
    if (tipoMedida === "metro_linear") {
        quantidade = medidaPuxadorMm / 1000
    } else {
        quantidade = quantidadePortas
    }

    return {
        puxador,
        tipoMedida,
        quantidade,
        medidaPuxadorMm
    }
}

function normalizarTagValor(valor) {
    return String(valor || "")
        .trim()
        .toLowerCase()
        .replace(/[^a-z0-9]+/g, " ")
        .trim()
}

function obterTagCorrespondente() {
    const perfil = todosPerfis.find(p => p.id == document.getElementById("perfil")?.value)
    const vidro = todosVidros.find(v => v.id == document.getElementById("vidro")?.value)
    if (!perfil || !vidro || !Array.isArray(todasTags) || todasTags.length === 0) return null

    const perfilKey = normalizarTagValor(perfil.nome)
    const espessura = String(vidro.espessura || "").trim()
    const vidroDescricaoTraco = [vidro.tipo, espessura].filter(Boolean).join(" - ")
    const vidroDescricaoEspaco = [vidro.tipo, espessura].filter(Boolean).join(" ")
    const vidroDescricaoMm = [vidro.tipo, espessura ? `${espessura}mm` : ""].filter(Boolean).join(" ")
    const vidroKeys = [
        vidroDescricaoTraco,
        vidroDescricaoEspaco,
        vidroDescricaoMm,
        vidro.tipo
    ].filter(Boolean).map(normalizarTagValor)

    return todasTags.find((tag) => {
        const tags = Array.isArray(tag.tags) ? tag.tags.map(normalizarTagValor) : []
        const perfisTag = normalizarTagValor(tag.perfis)
        const vidrosTag = normalizarTagValor(tag.vidros)
        const matchesPerfis = perfisTag ? perfisTag === perfilKey : true
        const matchesVidros = vidrosTag ? vidroKeys.includes(vidrosTag) : true

        if (tags.length) {
            const matchesTagsPerfis = tags.includes(perfilKey)
            const matchesTagsVidros = vidroKeys.some(key => tags.includes(key))
            return matchesTagsPerfis && matchesTagsVidros && matchesPerfis && matchesVidros
        }

        return (perfisTag || vidrosTag) && matchesPerfis && matchesVidros
    }) || null
}

function calcularMedidasPorta() {
    const larguraMm = +document.getElementById("largura")?.value || 0
    const alturaMm = +document.getElementById("altura")?.value || 0
    const larguraM = larguraMm / 1000
    const alturaM = alturaMm / 1000
    return {
        larguraMm,
        alturaMm,
        larguraM,
        alturaM,
        area: larguraM * alturaM,
        perimetro: 2 * (larguraM + alturaM)
    }
}

function calcularTagAplicada(tag, medidas) {
    if (!tag || !tag.valor || !medidas) return null
    let quantidade = 0
    if (tag.medida === "m2") {
        quantidade = medidas.area
    } else if (tag.medida === "perimetro") {
        quantidade = medidas.perimetro
    } else if (tag.medida === "unidade") {
        quantidade = 1
    }
    if (!quantidade) return null
    const valorUnitario = Number(tag.valor) || 0
    return {
        tag,
        quantidade,
        total: valorUnitario * quantidade
    }
}

function calcularPrecoPorta(){
    const medidas = calcularMedidasPorta()
    const largura = medidas.larguraM
    const altura = medidas.alturaM
    const perfil = todosPerfis.find(p=>p.id==document.getElementById("perfil")?.value)
    const vidro = todosVidros.find(v=>v.id==document.getElementById("vidro")?.value)
    const quantidadePortas = +document.getElementById("quantidade")?.value || 1
    const valorAdicional = +document.getElementById("valor_adicional")?.value || 0
    const perimetro = medidas.perimetro
    const insumos = (perfil?.insumos || [])
        .map((nome) => todosInsumos.find((insumo) => insumo.nome === nome))
        .filter(Boolean)

    let total = 0
    if(perfil) total += perfil.preco * 2 * (largura + altura)
    if(vidro) total += vidro.preco * largura * altura
    insumos.forEach((insumo) => {
        const tipo = insumo.tipo_medida
        let quantidadeInsumo = 0
        if (tipo === "metro_linear") {
            quantidadeInsumo = perimetro
        } else if (tipo === "unidade") {
            quantidadeInsumo = quantidadePortas
        }
        total += (insumo.preco || 0) * quantidadeInsumo
    })

    const puxadorInfo = obterDadosPuxador()
    if (puxadorInfo) {
        total += (puxadorInfo.puxador.preco || 0) * puxadorInfo.quantidade
    }

    const tagAplicada = calcularTagAplicada(obterTagCorrespondente(), medidas)
    if (tagAplicada) {
        total += tagAplicada.total
    }

    total += valorAdicional
    return total * quantidadePortas
}

function atualizarPrecoPorta(){
    const preco = calcularPrecoPorta()
    const precoEl = document.getElementById("precoPorta")
    if (precoEl) {
        precoEl.textContent = `Pre√ßo estimado: R$ ${preco.toFixed(2)}`
    }
    atualizarDetalhesCusto()
    desenharPorta()
}

function toggleDetalhesCustos() {
    const detalhes = document.getElementById("detalhesCustos")
    const toggle = document.getElementById("toggleCustos")
    if (!detalhes || !toggle) return
    detalhes.style.display = toggle.checked ? "block" : "none"
    if (toggle.checked) {
        atualizarDetalhesCusto()
    }
}

function formatarMoeda(valor) {
    return `R$ ${Number(valor).toFixed(2)}`
}

function atualizarDetalhesCusto() {
    const detalhes = document.getElementById("detalhesCustos")
    const toggle = document.getElementById("toggleCustos")
    if (!detalhes || !toggle || !toggle.checked) return

    const largura = (+document.getElementById("largura")?.value || 0) / 1000
    const altura = (+document.getElementById("altura")?.value || 0) / 1000
    const quantidadePortas = +document.getElementById("quantidade")?.value || 1
    const valorAdicional = +document.getElementById("valor_adicional")?.value || 0
    const perimetro = 2 * (largura + altura)

    const perfil = todosPerfis.find(p => p.id == document.getElementById("perfil")?.value)
    const vidro = todosVidros.find(v => v.id == document.getElementById("vidro")?.value)
    const insumos = (perfil?.insumos || [])
        .map((nome) => todosInsumos.find((insumo) => insumo.nome === nome))
        .filter(Boolean)

    const puxadorInfo = obterDadosPuxador()
    const medidas = calcularMedidasPorta()
    const tagAplicada = calcularTagAplicada(obterTagCorrespondente(), medidas)

    if (!perfil && !vidro && insumos.length === 0 && !puxadorInfo && valorAdicional <= 0) {
        detalhes.innerHTML = "<em>Selecione perfil, vidro e tipologia para ver os custos.</em>"
        return
    }

    const linhas = []
    let custoTotal = 0
    let precoTotal = 0

    if (perfil) {
        const custoPerfil = (perfil.custo || 0) * perimetro
        const precoPerfil = (perfil.preco || 0) * perimetro
        custoTotal += custoPerfil
        precoTotal += precoPerfil
        linhas.push({
            item: `Perfil (${perfil.nome})`,
            quantidade: `${perimetro.toFixed(2)} m`,
            custo: custoPerfil,
            preco: precoPerfil
        })
    }

    if (vidro) {
        const area = largura * altura
        const custoVidro = (vidro.custo || 0) * area
        const precoVidro = (vidro.preco || 0) * area
        custoTotal += custoVidro
        precoTotal += precoVidro
        linhas.push({
            item: `Vidro (${vidro.tipo})`,
            quantidade: `${area.toFixed(2)} m¬≤`,
            custo: custoVidro,
            preco: precoVidro
        })
    }

    insumos.forEach((insumo) => {
        const tipo = insumo.tipo_medida
        let quantidadeInsumo = 0
        if (tipo === "metro_linear") {
            quantidadeInsumo = perimetro
        } else if (tipo === "unidade") {
            quantidadeInsumo = quantidadePortas
        } else {
            return
        }

        const custoInsumo = (insumo.custo || 0) * quantidadeInsumo
        const precoInsumo = (insumo.preco || 0) * quantidadeInsumo
        custoTotal += custoInsumo
        precoTotal += precoInsumo
        linhas.push({
            item: `Insumo (${insumo.nome})`,
            quantidade: tipo === "metro_linear"
                ? `${quantidadeInsumo.toFixed(2)} m`
                : `${quantidadeInsumo} un`,
            custo: custoInsumo,
            preco: precoInsumo
        })
    })

    if (puxadorInfo) {
        const custoPuxador = (puxadorInfo.puxador.custo || 0) * puxadorInfo.quantidade
        const precoPuxador = (puxadorInfo.puxador.preco || 0) * puxadorInfo.quantidade
        custoTotal += custoPuxador
        precoTotal += precoPuxador
        linhas.push({
            item: `Puxador (${puxadorInfo.puxador.nome})`,
            quantidade: puxadorInfo.tipoMedida === "metro_linear"
                ? `${puxadorInfo.quantidade.toFixed(2)} m`
                : `${puxadorInfo.quantidade} un`,
            custo: custoPuxador,
            preco: precoPuxador
        })
    }

    if (valorAdicional > 0) {
        custoTotal += valorAdicional
        precoTotal += valorAdicional
        linhas.push({
            item: "Valor adicional",
            quantidade: "1 un",
            custo: valorAdicional,
            preco: valorAdicional
        })
    }

    if (tagAplicada) {
        custoTotal += tagAplicada.total
        precoTotal += tagAplicada.total
        const unidadeTexto = tagAplicada.tag.medida === "m2"
            ? "m¬≤"
            : tagAplicada.tag.medida === "perimetro"
                ? "m"
                : "un"
        const tagNome = Array.isArray(tagAplicada.tag.tags) && tagAplicada.tag.tags.length
            ? tagAplicada.tag.tags.join(", ")
            : [tagAplicada.tag.perfis, tagAplicada.tag.vidros].filter(Boolean).join(" - ") || "Tag aplicada"
        linhas.push({
            item: `Tag (${tagNome})`,
            quantidade: `${tagAplicada.quantidade.toFixed(2)} ${unidadeTexto}`,
            custo: tagAplicada.total,
            preco: tagAplicada.total
        })
    }

    detalhes.innerHTML = `
        <strong>Detalhamento de custos e pre√ßos</strong>
        <table>
            <thead>
                <tr>
                    <th>Item</th>
                    <th>Quantidade</th>
                    <th>Custo</th>
                    <th>Pre√ßo</th>
                </tr>
            </thead>
            <tbody>
                ${linhas.map((linha) => `
                    <tr>
                        <td>${linha.item}</td>
                        <td>${linha.quantidade}</td>
                        <td>${formatarMoeda(linha.custo)}</td>
                        <td>${formatarMoeda(linha.preco)}</td>
                    </tr>
                `).join("")}
            </tbody>
            <tfoot>
                <tr>
                    <th colspan="2">Totais</th>
                    <th>${formatarMoeda(custoTotal)}</th>
                    <th>${formatarMoeda(precoTotal)}</th>
                </tr>
            </tfoot>
        </table>
    `
}

// =====================
// RENDER CAMPOS
// =====================
function renderCampos(){
    const tipo = document.getElementById("tipologia").value
    const container = document.getElementById("campos")
    container.innerHTML=""
    if(!TIPOLOGIAS[tipo]) return

    TIPOLOGIAS[tipo].forEach(c=>{
        const map={
            largura:`Largura (mm)<input id="largura" type="number" value="800" data-required="true" oninput="desenharPorta(); atualizarPrecoPorta(); atualizarLimiteDobradicas(); atualizarCamposObrigatorios()">`,
            altura:`Altura (mm)<input id="altura" type="number" value="2000" data-required="true" oninput="desenharPorta(); atualizarPrecoPorta(); atualizarLimiteDobradicas(); atualizarCamposObrigatorios()">`,
            perfil:`Perfil<select id="perfil" data-required="true" onchange="atualizarPrecoPorta(); atualizarCamposObrigatorios()"></select>`,
            vidro:`Vidro<select id="vidro" data-required="true" onchange="atualizarPrecoPorta(); atualizarCamposObrigatorios()"></select>`,
            dobradicas:`Quantidade de dobradi√ßas<input id="dobradicas" type="number" value="0" min="0" oninput="atualizarDobradicasInputs(); atualizarPrecoPorta(); atualizarCamposObrigatorios()">`,
            dobradicas_alturas:`Alturas das dobradi√ßas<div id="dobradicasContainer" class="helper-text">Defina a quantidade para gerar os campos.</div>`,
            puxador:`Puxador<select id="puxador" data-required="true" onchange="atualizarPuxadorTipo(); atualizarPrecoPorta(); atualizarCamposObrigatorios()"></select>`,
            altura_puxador:`Altura do puxador (mm)<input id="altura_puxador" type="number" value="1000" min="0" oninput="desenharPorta()">`,
            medida_puxador:`Tamanho do puxador (mm)<input id="medida_puxador" type="number" value="0" min="0" oninput="atualizarPrecoPorta(); desenharPorta()">`,
            valor_adicional:`Valor adicional (R$)<input id="valor_adicional" type="number" value="0" min="0" step="0.01" oninput="atualizarPrecoPorta()">`,
            puxadores:`Descri√ß√£o do puxador<input id="puxadores" type="text" placeholder="Ex: puxador 60cm">`,
            acessorio:`Acess√≥rio<textarea id="acessorio" rows="2"></textarea>`,
            observacao_venda:`Observa√ß√£o de venda<textarea id="observacao_venda" rows="2"></textarea>`,
            observacao_producao:`Observa√ß√£o de produ√ß√£o<textarea id="observacao_producao" rows="2"></textarea>`,
            trilho:`Trilho<textarea id="trilho" rows="2"></textarea>`,
            pivo:`Pivo<textarea id="pivo" rows="2"></textarea>`
        }
        if(map[c]) container.innerHTML+=`<label>${map[c]}</label>`
    })
    atualizarPerfisSelect()
    atualizarVidrosSelect()
    atualizarPuxadoresSelect()
    atualizarPuxadorTipo()
    atualizarDobradicasInputs()
    atualizarPrecoPorta()
    desenharPorta()
    atualizarCamposObrigatorios()
}

function atualizarPuxadorTipo() {
    const puxadorId = document.getElementById("puxador")?.value
    const medidaInput = document.getElementById("medida_puxador")
    if (!medidaInput) return

    if (puxadorId === "sem_puxador") {
        medidaInput.disabled = true
        medidaInput.value = "0"
        return
    }

    const puxador = todosPuxadores.find(p => p.id == puxadorId)
    if (!puxador) {
        medidaInput.disabled = true
        medidaInput.value = "0"
        return
    }

    medidaInput.disabled = puxador.tipo_medida !== "metro_linear"
    if (puxador.tipo_medida !== "metro_linear") {
        medidaInput.value = "0"
    }
}

function atualizarLimiteDobradicas() {
    const altura = +document.getElementById("altura")?.value || 0
    const dobradicasInput = document.getElementById("dobradicas")
    if (!dobradicasInput) return
    dobradicasInput.max = Math.max(0, Math.floor(altura))
}

function atualizarDobradicasInputs() {
    const quantidade = parseInt(document.getElementById("dobradicas")?.value || "0", 10) || 0
    const container = document.getElementById("dobradicasContainer")
    if (!container) return
    container.innerHTML = ""

    if (quantidade <= 0) {
        container.innerHTML = "<span class=\"helper-text\">Nenhuma dobradi√ßa definida.</span>"
        desenharPorta()
        return
    }

    const altura = +document.getElementById("altura")?.value || 0
    for (let i = 0; i < quantidade; i += 1) {
        const input = document.createElement("input")
        input.type = "number"
        input.min = "0"
        input.max = String(altura)
        input.placeholder = `Altura da dobradi√ßa ${i + 1} (mm)`
        input.className = "dobradica-altura"
        input.addEventListener("input", desenharPorta)
        container.appendChild(input)
    }
    desenharPorta()
}

function obterAlturasDobradicas() {
    return Array.from(document.querySelectorAll(".dobradica-altura"))
        .map((el) => parseInt(el.value || "0", 10))
        .filter((valor) => !Number.isNaN(valor) && valor > 0)
}

function atualizarCamposObrigatorios() {
    const campos = document.querySelectorAll("[data-required='true']")
    campos.forEach((campo) => {
        const valor = campo.value?.trim()
        const preenchido = valor !== "" && valor !== "0"
        campo.classList.toggle("required-empty", !preenchido)
        campo.classList.toggle("required-filled", preenchido)
    })
}

// =====================
// SVG
// =====================
function desenharPorta(){
    const svg = document.getElementById("portaSVG")
    const w = +document.getElementById("largura")?.value
    const h = +document.getElementById("altura")?.value
    if(!w||!h) return
    svg.innerHTML=""
    const scale = Math.min(200/w, 380/h)
    const doorWidth = w * scale
    const doorHeight = h * scale
    const offsetX = 10
    const offsetY = 10

    svg.innerHTML = `<rect x="${offsetX}" y="${offsetY}" width="${doorWidth}" height="${doorHeight}" fill="#dfe9f5" stroke="#1079ba" stroke-width="6"/>`

    const alturasDobradicas = obterAlturasDobradicas()
    alturasDobradicas.forEach((posicaoMm) => {
        const y = offsetY + doorHeight - (posicaoMm * scale)
        const x = offsetX + 6
        svg.innerHTML += `<line x1="${x}" y1="${y}" x2="${x + 18}" y2="${y}" stroke="#000" stroke-width="3"/>`
        svg.innerHTML += `<circle cx="${x}" cy="${y}" r="4" fill="#000"/>`
    })

    const puxadorId = document.getElementById("puxador")?.value
    if (puxadorId === "sem_puxador") return
    const puxador = todosPuxadores.find(p => p.id == puxadorId)
    const alturaPuxador = +document.getElementById("altura_puxador")?.value || 0
    const medidaPuxadorMm = +document.getElementById("medida_puxador")?.value || 0
    if (puxador && alturaPuxador > 0) {
        const puxadorColor = "#d48400"
        const puxadorAltura = medidaPuxadorMm > 0 ? medidaPuxadorMm * scale : doorHeight * 0.4
        const yCenter = offsetY + doorHeight - (alturaPuxador * scale)
        const y = yCenter - puxadorAltura / 2
        const x = offsetX + doorWidth - 10
        svg.innerHTML += `<rect x="${x}" y="${y}" width="6" height="${puxadorAltura}" fill="${puxadorColor}"/>`
        svg.innerHTML += `<circle cx="${x + 3}" cy="${y}" r="4" fill="${puxadorColor}"/>`
        svg.innerHTML += `<circle cx="${x + 3}" cy="${y + puxadorAltura}" r="4" fill="${puxadorColor}"/>`
    }
}

// =====================
// PORTAS LOCAL
// =====================
let portas=[], editando=null, idCounter=0

async function salvarPorta(){
    const tipo = document.getElementById("tipologia").value
    if(!tipo) return alert("Selecione a tipologia")

    const medidas = calcularMedidasPorta()
    const largura = medidas.larguraMm
    const altura = medidas.alturaMm
    const quantidade = +document.getElementById("quantidade")?.value || 0
    const perfilSelecionado = document.getElementById("perfil")?.value
    const vidroSelecionado = document.getElementById("vidro")?.value
    const puxadorSelecionado = document.getElementById("puxador")?.value
    const dobradicasQtd = parseInt(document.getElementById("dobradicas")?.value || "0", 10) || 0
    const alturasDobradicas = obterAlturasDobradicas()

    const pendencias = []
    if (!largura) pendencias.push("Largura")
    if (!altura) pendencias.push("Altura")
    if (!quantidade) pendencias.push("Quantidade")
    if (!perfilSelecionado) pendencias.push("Perfil")
    if (!vidroSelecionado) pendencias.push("Vidro")
    if (!puxadorSelecionado) pendencias.push("Puxador")
    if (tipo === "giro" && dobradicasQtd < 2) pendencias.push("Dobradi√ßas (m√≠nimo 2)")
    if (dobradicasQtd > 0 && alturasDobradicas.length !== dobradicasQtd) {
        pendencias.push("Alturas das dobradi√ßas")
    }

    if (pendencias.length > 0) {
        alert(`Preencha os campos obrigat√≥rios: ${pendencias.join(", ")}`)
        return
    }

    const dados = {}
    TIPOLOGIAS[tipo].forEach(c=>{
        const el = document.getElementById(c)
        if(el) dados[c] = el.value
    })
    dados.dobradicas_alturas = obterAlturasDobradicas()

    const porta = {
        id: editando ?? idCounter++,
        tipo,
        dados,
        quantidade,
        m2: Number(medidas.area.toFixed(4)),
        metro_linear: Number(medidas.perimetro.toFixed(4)),
        tag_aplicada: calcularTagAplicada(obterTagCorrespondente(), medidas),
        preco: calcularPrecoPorta(),
        svg: portaSVG.outerHTML
    }
    const nextPortas = editando === null
        ? [...portas, porta]
        : portas.map(p => (p.id === editando ? porta : p))
    const portasComUUID = nextPortas.map(p => ({ ...p, orcamento_uuid: ORCAMENTO_UUID }))
    try {
        const resPortas = await fetch(`${API_BASE}/api/orcamento/${ORCAMENTO_UUID}/portas`, {
            method: "POST",
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ portas: portasComUUID })
        })
        const dataPortas = await resPortas.json()
        if (!dataPortas.success) throw new Error(dataPortas.error || "Erro ao salvar portas")

        alert("Porta salva com sucesso!")
        portas = nextPortas
        editando = null
        renderPortas()
    } catch (err) {
        console.error(err)
        alert("Erro ao salvar porta: " + err.message)
    }
}

function renderPortas(){
    const c = document.getElementById("portasSalvas")
    c.innerHTML = ""
    portas.forEach((p, idx)=>{
        const perfilNome = todosPerfis.find(perfil => perfil.id == p.dados.perfil)?.nome || "Perfil n√£o definido"
        const vidroNome = todosVidros.find(vidro => vidro.id == p.dados.vidro)?.tipo || "Vidro n√£o definido"
        const puxadorNome = p.dados.puxador === "sem_puxador"
            ? "Sem puxador"
            : (todosPuxadores.find(puxador => puxador.id == p.dados.puxador)?.nome || "Puxador n√£o definido")
        const valorAdicional = Number(p.dados.valor_adicional || 0)
        const quantidadeDobradicas = parseInt(p.dados.dobradicas || "0", 10) || 0
        c.innerHTML += `
            <div>
                <strong>${idx+1}. ${p.tipo}</strong><br>
                Quantidade: ${p.quantidade}<br>
                Perfil: ${perfilNome}<br>
                Vidro: ${vidroNome}<br>
                Puxador: ${puxadorNome}<br>
                Valor adicional: ${valorAdicional ? formatarMoeda(valorAdicional) : "-"}<br>
                Dobradi√ßas: ${quantidadeDobradicas}<br>
                Pre√ßo: R$ ${p.preco.toFixed(2)}<br>
                ${p.svg}<br>
                <button class="btn" onclick="copiarPorta(${p.id})">Copiar</button>
                <button class="btn" onclick="editarPorta(${p.id})">Editar</button>
                <button class="btn btn-danger" onclick="apagarPorta(${p.id})">Apagar</button>
            </div>
        `
    })
    atualizarResumoImpressao()
    atualizarResumoOrdem()
}

function editarPorta(id){
    const porta = portas.find(p=>p.id===id)
    if(!porta) return
    editando = id
    document.getElementById("tipologia").value = porta.tipo
    document.getElementById("quantidade").value = porta.quantidade
    renderCampos()
    for(const k in porta.dados){
        const el=document.getElementById(k)
        if(el) el.value = porta.dados[k]
    }
    if (Array.isArray(porta.dados.dobradicas_alturas)) {
        const inputs = document.querySelectorAll(".dobradica-altura")
        porta.dados.dobradicas_alturas.forEach((altura, idx) => {
            if (inputs[idx]) inputs[idx].value = altura
        })
    }
    atualizarPuxadorTipo()
    atualizarPrecoPorta()
    desenharPorta()
}

function copiarPorta(id){
    const porta = portas.find(p=>p.id===id)
    if(!porta) return
    editando = null
    document.getElementById("tipologia").value = porta.tipo
    document.getElementById("quantidade").value = porta.quantidade
    renderCampos()
    for(const k in porta.dados){
        const el=document.getElementById(k)
        if(el) el.value = porta.dados[k]
    }
    if (Array.isArray(porta.dados.dobradicas_alturas)) {
        const inputs = document.querySelectorAll(".dobradica-altura")
        porta.dados.dobradicas_alturas.forEach((altura, idx) => {
            if (inputs[idx]) inputs[idx].value = altura
        })
    }
    atualizarPuxadorTipo()
    atualizarPrecoPorta()
    desenharPorta()
}

function apagarPorta(id){
    if(!confirm("Tem certeza que deseja apagar esta porta?")) return
    portas = portas.filter(p=>p.id!==id)
    renderPortas()
}

// =====================
// IMPRESS√ÉO
// =====================
function obterRecuosPuxador(alturaPorta, alturaPuxador, tamanhoPuxador) {
    if (!alturaPorta || !alturaPuxador || !tamanhoPuxador) return { recuoTopo: null, recuoBase: null }
    const inicio = alturaPuxador - tamanhoPuxador / 2
    const fim = alturaPuxador + tamanhoPuxador / 2
    return {
        recuoBase: Math.max(0, inicio),
        recuoTopo: Math.max(0, alturaPorta - fim)
    }
}

function obterIdentificacaoOrcamento() {
    const nome = orcamentoInfo?.cliente_nome || "-"
    const numero = orcamentoInfo?.numero_pedido ?? "-"
    return `Cliente: ${nome} | Pedido: ${numero}`
}

function obterCidadeCliente() {
    return orcamentoInfo?.cliente_cidade || "-"
}

function obterDataHoje() {
    return new Date().toLocaleDateString("pt-BR")
}

function atualizarResumoImpressao() {
    const resumo = document.getElementById("printResumo")
    if (!resumo) return
    if (portas.length === 0) {
        resumo.innerHTML = ""
        return
    }

    let totalGeral = 0
    const itens = portas.map((p, index) => {
        const largura = p.dados.largura || "-"
        const altura = p.dados.altura || "-"
        const puxador = p.dados.puxador === "sem_puxador"
            ? null
            : todosPuxadores.find(pux => pux.id == p.dados.puxador)
        const puxadorNome = puxador ? puxador.nome : "Sem puxador"
        const precoTotal = p.preco || 0
        totalGeral += precoTotal

        return `
            <div class="print-item">
                Quantidade: ${p.quantidade}<br>
                Altura: ${altura} mm<br>
                Largura: ${largura} mm<br>
                Puxador: ${puxadorNome}<br>
                Valor do item: ${formatarMoeda(precoTotal)}
            </div>
        `
    }).join("")

    resumo.innerHTML = `
        <h2>Resumo do Or√ßamento</h2>
        <p>${obterIdentificacaoOrcamento()}</p>
        ${itens}
        <h3>Total geral: ${formatarMoeda(totalGeral)}</h3>
    `
}

function gerarSvgOrdemProducao(porta) {
    const largura = parseFloat(porta.dados.largura || 0)
    const altura = parseFloat(porta.dados.altura || 0)
    if (!largura || !altura) return ""

    const w = 400
    const h = 600
    const scale = Math.min(w / largura, h / altura)

    const doorWidth = largura * scale
    const doorHeight = altura * scale
    const offsetX = 90
    const offsetY = 30

    const puxadorId = porta.dados.puxador
    const deveDesenharPuxador = puxadorId && puxadorId !== "sem_puxador"
    const handleLength = deveDesenharPuxador ? parseFloat(porta.dados.medida_puxador || 0) : 0
    const handlePos = deveDesenharPuxador ? parseFloat(porta.dados.altura_puxador || 0) : 0
    const recuos = obterRecuosPuxador(altura, handlePos, handleLength)

    const handleScaled = handleLength > 0 ? handleLength * scale : doorHeight * 0.4
    const handleCenter = offsetY + doorHeight - (handlePos * scale)
    const handleY = handleCenter - handleScaled / 2
    const handleX = offsetX + doorWidth - 12
    const quantidadeTexto = `${porta.quantidade || 1}x`
    const alturasDobradicas = Array.isArray(porta.dados.dobradicas_alturas)
        ? porta.dados.dobradicas_alturas
        : []
    const dobradicasSvg = alturasDobradicas.map((posicaoMm) => {
        const posicao = parseFloat(posicaoMm || 0)
        if (!posicao) return ""
        const y = offsetY + doorHeight - (posicao * scale)
        const x = offsetX + 6
        return `
          <line x1="${x}" y1="${y}" x2="${x + 20}" y2="${y}" stroke="#000" stroke-width="3"/>
          <circle cx="${x}" cy="${y}" r="4" fill="#000"/>
        `
    }).join("")

    return `
    <svg class="op-svg" width="520" height="720" viewBox="0 0 520 720" xmlns="http://www.w3.org/2000/svg">
      <rect x="${offsetX}" y="${offsetY}" width="${doorWidth}" height="${doorHeight}" fill="#f4f8ff" stroke="#1079ba" stroke-width="3"/>
      ${dobradicasSvg}
      ${deveDesenharPuxador ? `<rect x="${handleX}" y="${handleY}" width="8" height="${handleScaled}" fill="#d48400"/>` : ""}
      <text x="${offsetX + doorWidth / 2}" y="${offsetY + doorHeight / 2}" text-anchor="middle" dominant-baseline="middle" class="op-quantity">${quantidadeTexto}</text>

      <line x1="${offsetX - 20}" y1="${offsetY}" x2="${offsetX - 20}" y2="${offsetY + doorHeight}" stroke="#333"/>
      <line x1="${offsetX - 24}" y1="${offsetY}" x2="${offsetX}" y2="${offsetY}" stroke="#333"/>
      <line x1="${offsetX - 24}" y1="${offsetX + doorHeight}" x2="${offsetX}" y2="${offsetX + doorHeight}" stroke="#333"/>
      <text x="${offsetX - 50}" y="${offsetY + doorHeight / 2}" class="op-measure" transform="rotate(-90 ${offsetX - 50} ${offsetX - 50} ${offsetY + doorHeight / 2})">${altura} mm</text>

      <line x1="${offsetX}" y1="${offsetY + doorHeight + 20}" x2="${offsetX + doorWidth}" y2="${offsetY + doorHeight + 20}" stroke="#333"/>
      <line x1="${offsetX}" y1="${offsetY + doorHeight + 16}" x2="${offsetX}" y2="${offsetX + doorHeight + 24}" stroke="#333"/>
      <line x1="${offsetX + doorWidth}" y1="${offsetX + doorHeight + 16}" x2="${offsetX + doorWidth}" y2="${offsetX + doorHeight + 24}" stroke="#333"/>
      <text x="${offsetX + doorWidth / 2}" y="${offsetX + doorHeight + 48}" class="op-measure" text-anchor="middle">${largura} mm</text>
    </svg>
    `
}

function atualizarResumoOrdem() {
    const container = document.getElementById("printOrdem")
    if (!container) return
    if (portas.length === 0) {
        container.innerHTML = ""
        return
    }

    const itens = portas.map((p, index) => {
        const perfilNome = todosPerfis.find(perfil => perfil.id == p.dados.perfil)?.nome || "-"
        const vidroNome = todosVidros.find(vidro => vidro.id == p.dados.vidro)?.tipo || "-"
        const puxadorNome = p.dados.puxador === "sem_puxador"
            ? "Sem puxador"
            : (todosPuxadores.find(puxador => puxador.id == p.dados.puxador)?.nome || "-")
        const valorAdicional = Number(p.dados.valor_adicional || 0)
        const observacaoVenda = p.dados.observacao_venda || "-"
        const observacaoProducao = p.dados.observacao_producao || "-"
        const quantidadeDobradicas = parseInt(p.dados.dobradicas || "0", 10) || 0
        const alturasDobradicas = Array.isArray(p.dados.dobradicas_alturas) && p.dados.dobradicas_alturas.length
            ? `${p.dados.dobradicas_alturas.join(" mm, ")} mm`
            : "-"
        const alturaPorta = parseFloat(p.dados.altura || 0)
        const alturaPuxador = parseFloat(p.dados.altura_puxador || 0)
        const medidaPuxador = parseFloat(p.dados.medida_puxador || 0)
        const recuos = obterRecuosPuxador(alturaPorta, alturaPuxador, medidaPuxador)
        const vaoPuxador = recuos.recuoBase === null
            ? "-"
            : `Base ${Math.round(recuos.recuoBase)} mm | Topo ${Math.round(recuos.recuoTopo)} mm`
        return `
            <div class="print-item op-page">
                <div>
                    ${gerarSvgOrdemProducao(p)}
                </div>
                <div class="op-info">
                    <div><strong>O.P. ${index + 1} - ${p.tipo}</strong></div>
                    <div>Perfil: ${perfilNome}</div>
                    <div>Vidro: ${vidroNome}</div>
                    <div>Puxador: ${puxadorNome}</div>
                    <div>Valor adicional: ${valorAdicional ? formatarMoeda(valorAdicional) : "-"}</div>
                    <div>Observa√ß√£o de venda: ${observacaoVenda}</div>
                    <div>Observa√ß√£o de produ√ß√£o: ${observacaoProducao}</div>
                    <div>Dobradi√ßas: ${quantidadeDobradicas} (alturas: ${alturasDobradicas})</div>
                    <div>V√£o do puxador: ${vaoPuxador}</div>
                </div>
            </div>
        `
    }).join("")

    container.innerHTML = `
        <h2>Ordem de Produ√ß√£o</h2>
        <p>${obterIdentificacaoOrcamento()}</p>
        ${itens}
    `
}

function atualizarEtiquetasTermicas() {
    const container = document.getElementById("printEtiqueta")
    if (!container) return
    if (portas.length === 0) {
        container.innerHTML = ""
        return
    }

    const dataHoje = obterDataHoje()
    const clienteNome = orcamentoInfo?.cliente_nome || "-"
    const pedidoNumero = orcamentoInfo?.numero_pedido ?? "-"
    const cidadeCliente = obterCidadeCliente()

    const etiquetas = []
    portas.forEach((porta, index) => {
        const quantidade = parseInt(porta.quantidade || "1", 10) || 1
        const largura = porta.dados.largura || "-"
        const altura = porta.dados.altura || "-"
        const perfilNome = todosPerfis.find(perfil => perfil.id == porta.dados.perfil)?.nome || "-"
        const vidroNome = todosVidros.find(vidro => vidro.id == porta.dados.vidro)?.tipo || "-"
        const descricao = `${index + 1} Porta - ${largura} x ${altura} mm`

        for (let i = 1; i <= quantidade; i += 1) {
            etiquetas.push(`
                <div class="thermal-label">
                    <div class="thermal-header">
                        <div><strong>Pedido:</strong> ${pedidoNumero}</div>
                        <div><strong>Data:</strong> ${dataHoje}</div>
                        <div><strong>Volume:</strong> ${i}/${quantidade}</div>
                        <div><strong>Cliente:</strong> ${clienteNome}</div>
                        <div><strong>Cidade:</strong> ${cidadeCliente}</div>
                    </div>
                    <div class="thermal-divider"></div>
                    <div class="thermal-body">
                        <div><strong>${descricao}</strong></div>
                        <div>${perfilNome}</div>
                        <div>${vidroNome}</div>
                    </div>
                    <div class="thermal-divider"></div>
                    <div class="thermal-footer">colorglassfortaleza.com.br</div>
                </div>
            `)
        }
    })

    container.innerHTML = etiquetas.join("")
}

function imprimirOrcamento() {
    atualizarResumoImpressao()
    document.getElementById("printResumo").classList.add("active")
    document.getElementById("printOrdem").classList.remove("active")
    document.getElementById("printEtiqueta").classList.remove("active")
    window.print()
}

function imprimirOrdemProducao() {
    atualizarResumoOrdem()
    document.getElementById("printOrdem").classList.add("active")
    document.getElementById("printResumo").classList.remove("active")
    document.getElementById("printEtiqueta").classList.remove("active")
    window.print()
}

function imprimirEtiquetaTermica() {
    atualizarEtiquetasTermicas()
    document.getElementById("printEtiqueta").classList.add("active")
    document.getElementById("printResumo").classList.remove("active")
    document.getElementById("printOrdem").classList.remove("active")
    window.print()
}

// =====================
// CARREGAR PORTAS EXISTENTES
// =====================
async function carregarPortas(){
    try{
        const res = await fetch(`${API_BASE}/api/orcamento/${ORCAMENTO_UUID}/portas`)
        const data = await res.json()
        if(data.success && data.portas){
            portas = data.portas.map((p) => ({ ...p, id: idCounter++ }))
            renderPortas()
        }
    } catch(err){
        console.error(err)
    }
}

async function carregarOrcamentoInfo() {
    try {
        const res = await fetch(`${API_BASE}/api/orcamentos`)
        const data = await res.json()
        if (data.success && Array.isArray(data.orcamentos)) {
            const encontrado = data.orcamentos.find((orcamento) => orcamento.id == ORCAMENTO_UUID)
            if (encontrado) {
                orcamentoInfo = {
                    cliente_nome: encontrado.cliente_nome || "-",
                    numero_pedido: encontrado.numero_pedido ?? "-",
                    cliente_cidade: encontrado.cliente_cidade || "-"
                }
            }
        }
    } catch (err) {
        console.error("Erro ao carregar informa√ß√µes do or√ßamento:", err)
    }
}

// =====================
// LINK ESTRUTURAS 3D
// =====================
function abrirEstrutura3D(){
    const url = `3dteste.html?orcamento_uuid=${ORCAMENTO_UUID}`;
    window.open(url, "_blank");
}

// =====================
// CARREGAR ESTRUTURAS 3D SALVAS
// =====================
let estruturas3D = [];

function carregarEstruturas3D() {
    try {
        const data = localStorage.getItem(`estruturas_${ORCAMENTO_UUID}`);
        if (!data) return;
        estruturas3D = JSON.parse(data);
        renderEstruturas3D();
    } catch (err) {
        console.error("Erro ao carregar estruturas 3D:", err);
    }
}

function renderEstruturas3D() {
    const container = document.getElementById("estruturas3DSalvas");
    container.innerHTML = "";
    estruturas3D.forEach((e, idx) => {
        container.innerHTML += `
            <div>
                <strong>Estrutura 3D ${idx + 1}</strong><br>
                Comprimento total: ${e.totalLength.toFixed(2)} mm<br>
                Fixadores: ${e.fixadores || "Nenhum"}<br>
                <button class="btn" onclick="verEstrutura3D(${idx})">Ver 3D</button>
            </div>
        `;
    });
}

function verEstrutura3D(idx) {
    const url = `3dteste.html?orcamento_uuid=${ORCAMENTO_UUID}&estrutura_idx=${idx}`;
    window.open(url, "_blank");
}

// =====================
carregarPerfis()
carregarVidros()
carregarInsumos()
carregarPuxadores()
carregarTags()
carregarPortas()
carregarEstruturas3D()
carregarOrcamentoInfo()
</script>
</body>
</html>











