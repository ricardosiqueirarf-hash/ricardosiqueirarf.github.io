<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Financeiro - Pedidos Aprovados</title>

<style>
* {
  box-sizing: border-box;
  margin: 0;
  padding: 0;
  font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
}

body {
  background: #f5f7fa;
  color: #111;
  padding: 24px;
}

h1 {
  margin-bottom: 8px;
  color: #1079ba;
}

.hint {
  color: #555;
  margin-bottom: 18px;
  font-size: 0.9rem;
}

.btn {
  background: #1079ba;
  color: #fff;
  border: none;
  border-radius: 8px;
  padding: 10px 14px;
  cursor: pointer;
  font-weight: 600;
}

.btn:hover {
  background: #0d5d8c;
}

.table-wrapper {
  background: #fff;
  border-radius: 10px;
  box-shadow: 0 4px 12px rgba(0,0,0,0.06);
  overflow-x: auto;
}

table {
  width: 100%;
  border-collapse: collapse;
  min-width: 760px;
}

th, td {
  padding: 12px 14px;
  text-align: left;
  border-bottom: 1px solid #eee;
}

th {
  background: #e6f0fa;
  color: #1f2937;
  font-weight: 700;
}

tr:last-child td {
  border-bottom: none;
}

tr.debito-em-aberto {
  background: rgba(239, 68, 68, 0.12);
}

.status {
  margin-top: 12px;
  font-size: 0.9rem;
  color: #555;
}
</style>
</head>

<body>

<h1>Financeiro</h1>
<p class="hint">
  Pedidos aprovados (status 2, 3, 4, 5).  
  Dados carregados com segurança via backend.
</p>

<button class="btn" onclick="carregarPedidos()">Atualizar</button>

<br><br>

<div class="table-wrapper">
  <table>
    <thead>
      <tr>
        <th>Nº Pedido</th>
        <th>Cliente</th>
        <th>Data</th>
        <th>Valor Total</th>
        <th>Valor Pago</th>
      </tr>
    </thead>
    <tbody id="tabelaPedidos">
      <tr>
        <td colspan="5"><em>Carregando...</em></td>
      </tr>
    </tbody>
  </table>
</div>

<div class="status" id="statusMensagem"></div>

<script>
function setStatus(msg) {
  document.getElementById("statusMensagem").textContent = msg;
}

function parseValor(v) {
  if (v === null || v === undefined || v === "") return 0;
  if (typeof v === "number") return v;

  return Number(
    String(v)
      .replace(/[^0-9,.-]/g, "")
      .replace(/\./g, "")
      .replace(",", ".")
  ) || 0;
}

function formatarData(v) {
  if (!v) return "--";
  const d = new Date(v);
  return isNaN(d) ? v : d.toLocaleString("pt-BR");
}

function renderizarPedidos(pedidos) {
  const tbody = document.getElementById("tabelaPedidos");
  tbody.innerHTML = "";

  if (!pedidos || !pedidos.length) {
    tbody.innerHTML =
      "<tr><td colspan='5'><em>Nenhum pedido encontrado.</em></td></tr>";
    return;
  }

  const fmt = new Intl.NumberFormat("pt-BR", {
    style: "currency",
    currency: "BRL"
  });

  pedidos.forEach(p => {
    const total = parseValor(p.valor_total);
    const pago = parseValor(p.valor_pago);

    const tr = document.createElement("tr");
    if (total > pago) tr.classList.add("debito-em-aberto");

    tr.innerHTML = `
      <td>${p.numero_pedido ?? "--"}</td>
      <td>${p.cliente_nome ?? "--"}</td>
      <td>${formatarData(p.data_criacao)}</td>
      <td>${fmt.format(total)}</td>
      <td>${fmt.format(pago)}</td>
    `;

    tbody.appendChild(tr);
  });
}

async function carregarPedidos() {
  try {
    setStatus("Carregando pedidos...");
    const res = await fetch("/api/financeiro");

    if (!res.ok) {
      throw new Error("Erro ao buscar dados do financeiro");
    }

    const dados = await res.json();
    renderizarPedidos(dados);
    setStatus(`${dados.length} pedido(s) carregado(s).`);
  } catch (err) {
    console.error(err);
    setStatus("Erro ao carregar pedidos.");
  }
}

document.addEventListener("DOMContentLoaded", carregarPedidos);
</script>

</body>
</html>

