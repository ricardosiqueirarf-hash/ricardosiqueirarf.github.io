<!DOCTYPE html>
<html lang="pt-br">
<head>
<meta charset="UTF-8">
<title>Upload de Comprovantes</title>
<meta name="viewport" content="width=device-width,initial-scale=1.0">
<style>
body{font-family:Arial;background:#f5f5f5;padding:40px}
.card{background:#fff;border-radius:12px;padding:24px;max-width:520px;margin:auto;box-shadow:0 0 30px rgba(0,0,0,.08)}
button{background:#1f6feb;color:#fff;border:none;padding:10px 18px;border-radius:8px;cursor:pointer}
button.sec{background:#111827}
.status{white-space:pre-wrap;margin-top:15px;font-size:14px}
img{max-width:100%;margin-top:15px;border-radius:8px}
</style>
</head>
<body>

<div class="card">
<h2>Enviar comprovante</h2>

<button id="login">Entrar com GitHub</button>
<button id="logout" class="sec">Logout</button>

<p id="auth"></p>

<input type="file" id="file" accept="image/*,application/pdf"><br><br>
<button id="upload">Enviar</button>

<p class="status" id="status"></p>
<div id="preview"></div>
</div>

<script type="module">
import { createClient } from "https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/+esm";

const supabase = createClient(
  "https://hfhwvzldhgqniqnurync.supabase.co",
  "sb_publishable_0j-jqB63odD2yvugj7olMA_s18OwuPl"
);

const BUCKET = "comprovantes";
const REDIRECT = "https://www.colorglassfortaleza.com.br/callback.html";

const auth = document.getElementById("auth");
const status = document.getElementById("status");
const preview = document.getElementById("preview");

function log(msg, obj){
  console.log(msg, obj || "");
  status.innerText += msg + (obj ? "\n" + JSON.stringify(obj,null,2) : "") + "\n\n";
}

function safeName(n){
  return n.normalize("NFD").replace(/[\u0300-\u036f]/g,"").replace(/[^a-zA-Z0-9._-]/g,"_");
}

async function refresh(){
  log("REFRESH AUTH...");
  const {data:{user}, error} = await supabase.auth.getUser();
  if(error){
    log("AUTH ERROR", error);
    return;
  }
  if(user){
    auth.innerText = "Logado: " + (user.email || user.user_metadata?.user_name || user.id);
    log("USER OK", user);
  } else {
    auth.innerText = "NÃ£o logado";
    log("NO USER");
  }
}

document.getElementById("login").onclick = async ()=>{
  log("CLICK LOGIN");
  const { error } = await supabase.auth.signInWithOAuth({
    provider: "github",
    options: { redirectTo: REDIRECT }
  });
  if(error){
    log("OAUTH ERROR", error);
  } else {
    log("OAUTH REDIRECTING...");
  }
};

document.getElementById("logout").onclick = async ()=>{
  await supabase.auth.signOut();
  log("LOGOUT");
  refresh();
};

document.getElementById("upload").onclick = async ()=>{
  log("CLICK UPLOAD");

  const {data:{user}, error:uerr} = await supabase.auth.getUser();
  if(uerr){ log("GET USER ERROR", uerr); return; }
  if(!user){ log("NOT LOGGED"); return; }

  const file = document.getElementById("file").files[0];
  if(!file){ log("NO FILE"); return; }

  const path = user.id + "/" + crypto.randomUUID() + "_" + safeName(file.name);
  log("UPLOAD PATH", path);

  log("SENDING TO SUPABASE...");
  const {data, error} = await supabase.storage.from(BUCKET).upload(path,file);

  if(error){
    log("UPLOAD ERROR", error);
    return;
  }

  log("UPLOAD OK", data);

  log("REQUEST SIGNED URL...");
  const {data:signed, error:e2} = await supabase.storage.from(BUCKET).createSignedUrl(path,600);

  if(e2){
    log("SIGNED ERROR", e2);
    return;
  }

  log("SIGNED OK", signed);

  if(file.type.startsWith("image")){
    const img = document.createElement("img");
    img.src = signed.signedUrl;
    preview.appendChild(img);
  } else {
    const a = document.createElement("a");
    a.href = signed.signedUrl;
    a.target="_blank";
    a.innerText="Abrir comprovante";
    preview.appendChild(a);
  }
};

refresh();
supabase.auth.onAuthStateChange(refresh);

supabase.auth.onAuthStateChange(refresh);
</script>
</body>
</html>






