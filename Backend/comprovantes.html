<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Upload de Comprovantes</title>
  <style>
    body { font-family: Arial, sans-serif; background: #f5f5f5; margin: 0; padding: 40px; }
    .card { background: #fff; border-radius: 12px; padding: 24px; max-width: 520px; margin: 0 auto;
      box-shadow: 0 6px 20px rgba(0,0,0,.08); }
    h1 { margin: 0 0 6px 0; font-size: 22px; }
    p { margin: 0 0 14px 0; color: #374151; }
    .field { margin: 16px 0; }
    button { background: #1f6feb; color: #fff; border: none; padding: 10px 18px; border-radius: 8px;
      cursor: pointer; font-size: 14px; }
    button.secondary { background: #111827; margin-left: 8px; }
    button:disabled { background: #9bbbf3; cursor: not-allowed; }
    .status { margin-top: 16px; font-size: 14px; color: #1f2937; white-space: pre-wrap; }
    .preview { margin-top: 12px; }
    .preview img { max-width: 100%; border-radius: 8px; display:block; }
    .preview a { display:inline-block; margin-top:10px; color:#1f6feb; text-decoration:none; font-weight:600; }
    .hint { font-size: 12px; color: #6b7280; margin-top: 6px; }
    hr { border: none; border-top: 1px solid #e5e7eb; margin: 18px 0; }
    .row { display:flex; gap:10px; flex-wrap:wrap; }
  </style>
</head>
<body>
  <div class="card">
    <h1>Enviar comprovante</h1>
    <p>Login GitHub → upload (Storage privado via Signed URL).</p>

    <div class="field">
      <div class="row">
        <button id="btnGithub" type="button">Entrar com GitHub</button>
        <button id="btnLogout" type="button" class="secondary">Logout</button>
      </div>
      <div class="hint">
        Você precisa estar logado porque a API exige <b>Bearer access_token</b> (policies por usuário).
      </div>
      <div class="status" id="authStatus"></div>
    </div>

    <hr />

    <div class="field">
      <input type="file" id="arquivo" accept="image/*,application/pdf" />
      <div class="hint">Aceita imagem e PDF.</div>
    </div>

    <button id="enviar" type="button">Fazer upload</button>

    <div class="status" id="status"></div>
    <div class="preview" id="preview"></div>
  </div>

  <script type="module">
    import { createClient } from "https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/+esm";

    // ============
    // CONFIG
    // ============
    const SUPABASE_URL = "https://hfhwvzldhgqniqnurync.supabase.co";
    const SUPABASE_ANON_KEY = "COLOQUE_SUA_ANON_KEY_AQUI";

    const supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    const btnGithub = document.getElementById("btnGithub");
    const btnLogout = document.getElementById("btnLogout");
    const authStatus = document.getElementById("authStatus");

    const botao = document.getElementById("enviar");
    const campoArquivo = document.getElementById("arquivo");
    const status = document.getElementById("status");
    const preview = document.getElementById("preview");

    const params = new URLSearchParams(window.location.search);
    const apiBase = params.get("apiBase") || window.location.origin;

    function setAuthStatus(msg) { authStatus.textContent = msg || ""; }
    function setStatus(msg) { status.textContent = msg || ""; }

    async function getAccessToken() {
      const { data: { session } } = await supabase.auth.getSession();
      return session?.access_token || null;
    }

    async function refreshAuth() {
      const { data: { user } } = await supabase.auth.getUser();
      if (user) {
        const provider = user.app_metadata?.provider || "oauth";
        setAuthStatus(`Logado via: ${provider}\nUsuário: ${user.email || user.user_metadata?.user_name || user.id}`);
      } else {
        setAuthStatus("Não logado.");
      }
    }

    btnGithub.addEventListener("click", async () => {
      try {
        setAuthStatus("Redirecionando para GitHub...");
        const { error } = await supabase.auth.signInWithOAuth({
          provider: "github",
          options: {
            // Volta pra esta mesma página após login
            redirectTo: window.location.href
          }
        });
        if (error) throw error;
      } catch (e) {
        setAuthStatus("Erro no login GitHub: " + (e?.message || e));
      }
    });

    btnLogout.addEventListener("click", async () => {
      try {
        await supabase.auth.signOut();
        setAuthStatus("Logout feito.");
      } catch (e) {
        setAuthStatus("Erro no logout: " + (e?.message || e));
      }
    });

    botao.addEventListener("click", async () => {
      setStatus("");
      preview.innerHTML = "";

      if (!campoArquivo.files.length) {
        setStatus("Selecione um arquivo antes de enviar.");
        return;
      }

      const token = await getAccessToken();
      if (!token) {
        setStatus("Você precisa entrar com GitHub antes (não existe access_token).");
        return;
      }

      const file = campoArquivo.files[0];
      const formData = new FormData();
      formData.append("arquivo", file);

      botao.disabled = true;
      setStatus("Enviando...");

      try {
        const resposta = await fetch(`${apiBase}/api/comprovantes/upload`, {
          method: "POST",
          headers: {
            Authorization: `Bearer ${token}`
          },
          body: formData
        });

        const data = await resposta.json().catch(() => ({}));

        if (!resposta.ok) {
          throw new Error(data.error || data.details || "Erro ao enviar arquivo.");
        }

        setStatus(
          `Upload OK!\n` +
          `Path: ${data.path || "(sem path)"}\n` +
          `Expira em: ${data.expires_in ? data.expires_in + "s" : "(?)"}`
        );

        const url = data.signed_url || data.url;
        if (!url) {
          preview.innerHTML = "<div class='hint'>Upload OK, mas não veio URL para preview.</div>";
          return;
        }

        if (file.type.startsWith("image/")) {
          const img = document.createElement("img");
          img.src = url;
          img.alt = "Comprovante enviado";
          preview.appendChild(img);
        } else {
          const a = document.createElement("a");
          a.href = url;
          a.target = "_blank";
          a.rel = "noreferrer";
          a.textContent = "Abrir comprovante (link temporário)";
          preview.appendChild(a);
        }
      } catch (error) {
        setStatus(`Falha: ${error.message}`);
      } finally {
        botao.disabled = false;
      }
    });

    // Atualiza status inicial e mudanças de sessão
    refreshAuth();
    supabase.auth.onAuthStateChange(() => refreshAuth());
  </script>
</body>
</html>




