<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Upload de Comprovantes</title>
  <style>
    body { font-family: Arial, sans-serif; background: #f5f5f5; margin: 0; padding: 40px; }
    .card { background: #ffffff; border-radius: 12px; padding: 24px; max-width: 520px; margin: 0 auto;
      box-shadow: 0 6px 20px rgba(0, 0, 0, 0.08); }
    h1 { margin-top: 0; font-size: 22px; }
    .field { margin: 16px 0; }
    button { background: #1f6feb; color: #ffffff; border: none; padding: 10px 18px; border-radius: 8px;
      cursor: pointer; font-size: 14px; }
    button.secondary { background: #111827; margin-left: 8px; }
    button:disabled { background: #9bbbf3; cursor: not-allowed; }
    .status { margin-top: 16px; font-size: 14px; color: #1f2937; white-space: pre-wrap; }
    .preview img { max-width: 100%; margin-top: 12px; border-radius: 8px; display:block; }
    .preview a { display:inline-block; margin-top:12px; color:#1f6feb; font-weight:700; text-decoration:none; }
    .hint { font-size: 12px; color: #6b7280; margin-top: 8px; }
    .row { display:flex; gap:10px; flex-wrap:wrap; }
  </style>
</head>
<body>
  <div class="card">
    <h1>Enviar comprovante</h1>
    <p>Entrar com GitHub → enviar arquivo → preview (signed URL).</p>

    <div class="row">
      <button id="btnGithub" type="button">Entrar com GitHub</button>
      <button id="btnLogout" type="button" class="secondary">Logout</button>
    </div>
    <div class="hint">O upload usa o token do Supabase (Bearer) pra respeitar sua policy do bucket.</div>
    <div class="status" id="authStatus"></div>

    <div class="field">
      <input type="file" id="arquivo" accept="image/*,application/pdf" />
    </div>

    <button id="enviar" type="button">Fazer upload</button>

    <div class="status" id="status"></div>
    <div class="preview" id="preview"></div>
  </div>

  <script type="module">
    import { createClient } from "https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/+esm";

    const SUPABASE_URL = "https://hfhwvzldhgqniqnurync.supabase.co";
    const SUPABASE_ANON_KEY = "COLOQUE_SUA_ANON_KEY_AQUI";

    const supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    const btnGithub = document.getElementById("btnGithub");
    const btnLogout = document.getElementById("btnLogout");
    const authStatus = document.getElementById("authStatus");

    const botao = document.getElementById("enviar");
    const campoArquivo = document.getElementById("arquivo");
    const status = document.getElementById("status");
    const preview = document.getElementById("preview");

    function setAuth(msg) { authStatus.textContent = msg || ""; }
    function setStatus(msg) { status.textContent = msg || ""; }

    async function refreshAuth() {
      const { data: { user } } = await supabase.auth.getUser();
      if (user) {
        const provider = user.app_metadata?.provider || "oauth";
        const label = user.email || user.user_metadata?.user_name || user.id;
        setAuth(`Logado via: ${provider}\nUsuário: ${label}`);
      } else {
        setAuth("Não logado.");
      }
    }

    async function getAccessToken() {
      const { data: { session } } = await supabase.auth.getSession();
      return session?.access_token || null;
    }

    btnGithub.addEventListener("click", async () => {
      setAuth("Redirecionando para GitHub...");
      const { error } = await supabase.auth.signInWithOAuth({
        provider: "github",
        options: {
          // MUITO IMPORTANTE: redireciona para callback.html no MESMO host do Flask
          redirectTo: `${window.location.origin}/callback.html`
        }
      });
      if (error) setAuth("Erro no login: " + error.message);
    });

    btnLogout.addEventListener("click", async () => {
      await supabase.auth.signOut();
      setAuth("Logout feito.");
    });

    botao.addEventListener("click", async () => {
      setStatus("");
      preview.innerHTML = "";

      if (!campoArquivo.files.length) {
        setStatus("Selecione um arquivo antes de enviar.");
        return;
      }

      const token = await getAccessToken();
      if (!token) {
        setStatus("Você precisa entrar com GitHub primeiro.");
        return;
      }

      botao.disabled = true;
      setStatus("Enviando...");

      try {
        const formData = new FormData();
        const file = campoArquivo.files[0];
        formData.append("arquivo", file);

        const resposta = await fetch(`/api/comprovantes/upload`, {
          method: "POST",
          headers: { Authorization: `Bearer ${token}` },
          body: formData
        });

        const data = await resposta.json().catch(() => ({}));
        if (!resposta.ok) throw new Error(data.error || data.details || "Erro ao enviar arquivo.");

        setStatus(
          `Upload OK!\nPath: ${data.path}\nExpira em: ${data.expires_in || data.expires || "?"}s`
        );

        const url = data.signed_url || data.url;
        if (!url) {
          preview.innerHTML = "<div class='hint'>Upload OK, mas não veio URL para preview.</div>";
          return;
        }

        if (file.type.startsWith("image/")) {
          const img = document.createElement("img");
          img.src = url;
          img.alt = "Comprovante";
          preview.appendChild(img);
        } else {
          const a = document.createElement("a");
          a.href = url;
          a.target = "_blank";
          a.rel = "noreferrer";
          a.textContent = "Abrir comprovante (link temporário)";
          preview.appendChild(a);
        }
      } catch (e) {
        setStatus("Falha: " + (e?.message || e));
      } finally {
        botao.disabled = false;
      }
    });

    refreshAuth();
    supabase.auth.onAuthStateChange(() => refreshAuth());
  </script>
</body>
</html>






