<!DOCTYPE html>
<html lang="pt-br">
<head>
<meta charset="UTF-8">
<title>Upload de Comprovantes</title>
<meta name="viewport" content="width=device-width,initial-scale=1.0">
<style>
body{font-family:Arial;background:#f5f5f5;padding:40px}
.card{background:#fff;border-radius:12px;padding:24px;max-width:520px;margin:auto;box-shadow:0 0 30px rgba(0,0,0,.08)}
button{background:#1f6feb;color:#fff;border:none;padding:10px 18px;border-radius:8px;cursor:pointer}
button.sec{background:#111827}
button.warn{background:#b45309}
.status{white-space:pre-wrap;margin-top:15px;font-size:13px;background:#f3f4f6;padding:10px;border-radius:10px}
img{max-width:100%;margin-top:15px;border-radius:8px}
a{display:inline-block;margin-top:12px}
.row{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
</style>
</head>
<body>

<script>
  // FORÃ‡A WWW (evita sessÃ£o sumir por origem diferente)
  if (location.hostname === "colorglassfortaleza.com.br") {
    location.replace("https://www.colorglassfortaleza.com.br" + location.pathname + location.search + location.hash);
  }
</script>

<div class="card">
  <h2>Enviar comprovante</h2>

  <div class="row">
    <button id="login">Entrar com GitHub</button>
    <button id="logout" class="sec">Logout</button>
    <button id="reset" class="warn" type="button">RESET AUTH</button>
  </div>

  <p id="auth"></p>

  <input type="file" id="file" accept="image/*,application/pdf"><br><br>
  <button id="upload">Enviar</button>

  <p class="status" id="status"></p>
  <div id="preview"></div>
</div>

<script type="module">
import { createClient } from "https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/+esm";

const SUPABASE_URL = "https://hfhwvzldhgqniqnurync.supabase.co";
const SUPABASE_ANON_KEY = "sb_publishable_0j-jqB63odD2yvugj7olMA_s18OwuPl";

const supabase = createClient(
  SUPABASE_URL,
  SUPABASE_ANON_KEY,
  { auth: { persistSession: true, autoRefreshToken: true, detectSessionInUrl: true } }
);

const BUCKET = "comprovantes";
const REDIRECT = "https://www.colorglassfortaleza.com.br/callback.html";

const auth = document.getElementById("auth");
const status = document.getElementById("status");
const preview = document.getElementById("preview");

function safeName(n){
  return (n || "comprovante")
    .normalize("NFD")
    .replace(/[\u0300-\u036f]/g,"")
    .replace(/[^a-zA-Z0-9._-]/g,"_");
}

function setStatus(txt){ status.innerText = txt || ""; }
function append(txt){ status.innerText += (txt || "") + "\n"; }
const sleep = (ms) => new Promise(r => setTimeout(r, ms));

function sbLocalStorageInfo(){
  const keys = Object.keys(localStorage);
  const sbKeys = keys.filter(k => k.includes("sb-") || k.includes("supabase"));
  const tokenKey = sbKeys.find(k => k.includes("-auth-token")) || null;

  let raw = null, parsed = null, access_token = null;
  try {
    raw = tokenKey ? localStorage.getItem(tokenKey) : null;
    parsed = raw ? JSON.parse(raw) : null;
    access_token = parsed?.access_token || parsed?.currentSession?.access_token || null;
  } catch (e) {}

  return { sbKeys, tokenKey, access_token_exists: !!access_token, access_token };
}

async function manualAuthUserCheck(){
  const info = sbLocalStorageInfo();
  append("MANUAL CHECK: access_token exists? " + info.access_token_exists);

  if(!info.access_token){
    append("MANUAL CHECK: sem access_token no localStorage.");
    return;
  }

  try{
    const r = await fetch(`${SUPABASE_URL}/auth/v1/user`, {
      method: "GET",
      headers: {
        apikey: SUPABASE_ANON_KEY,
        Authorization: "Bearer " + info.access_token
      }
    });
    const txt = await r.text();
    append("MANUAL /auth/v1/user STATUS=" + r.status);
    append(txt);
  } catch (e) {
    append("MANUAL /auth/v1/user THROW: " + (e?.message || e));
    console.error("manual user throw", e);
  }
}

async function refresh(){
  setStatus("");

  append("REFRESH AUTH...");
  append("HOST=" + location.host);
  append("ORIGIN=" + location.origin);
  append("");

  const info = sbLocalStorageInfo();
  append("LS KEYS:");
  append(info.sbKeys.length ? info.sbKeys.join("\n") : "(vazio)");
  append("");
  append("TOKEN KEY: " + (info.tokenKey || "(nenhuma)"));
  append("ACCESS TOKEN EXISTS? " + info.access_token_exists);
  append("");

  try {
    const sess = await supabase.auth.getSession();
    append("getSession OK");
    append(JSON.stringify(sess, null, 2));
    append("");
  } catch (e) {
    append("getSession THROW: " + (e?.message || e));
    append("");
    console.error("getSession throw", e);
  }

  try {
    const u = await supabase.auth.getUser();
    append("getUser OK");
    append(JSON.stringify(u, null, 2));
    append("");
    const user = u?.data?.user;

    if(user){
      auth.innerText = "Logado: " + (user.email || user.user_metadata?.user_name || user.id);
    } else {
      auth.innerText = "NÃ£o logado";
    }
  } catch (e) {
    auth.innerText = "NÃ£o logado (erro getUser)";
    append("getUser THROW: " + (e?.message || e));
    append("");
    console.error("getUser throw", e);
  }

  await manualAuthUserCheck();
}

async function createSignedUrlWithRetry(path, seconds=600){
  const delays = [0, 500, 1200, 2500]; // tenta imediato e depois aguarda
  let last = null;

  for (let i = 0; i < delays.length; i++){
    if (delays[i]) {
      append(`Aguardando ${delays[i]}ms para tentar assinar...`);
      await sleep(delays[i]);
    }

    const res = await supabase.storage.from(BUCKET).createSignedUrl(path, seconds);
    append("SIGNED TRY " + (i+1) + ":");
    append(JSON.stringify(res, null, 2));
    append("");

    if (!res.error && res.data?.signedUrl) return res;
    last = res;
  }

  return last;
}

document.getElementById("login").onclick = async ()=>{
  setStatus("CLICK LOGIN...\n");
  const { error } = await supabase.auth.signInWithOAuth({
    provider: "github",
    options: { redirectTo: REDIRECT }
  });
  if(error){
    append("OAUTH ERROR:");
    append(error.message);
    console.error(error);
    alert(error.message);
  } else {
    append("REDIRECTING...");
  }
};

document.getElementById("logout").onclick = async ()=>{
  await supabase.auth.signOut();
  await refresh();
};

document.getElementById("reset").onclick = async ()=>{
  setStatus("RESET AUTH...\n");
  try{ await supabase.auth.signOut(); } catch(e){}
  const keys = Object.keys(localStorage).filter(k => k.includes("sb-") || k.includes("supabase"));
  keys.forEach(k => localStorage.removeItem(k));
  append("REMOVIDAS KEYS:\n" + (keys.length ? keys.join("\n") : "(nenhuma)"));
  append("\nRELOAD...");
  location.reload();
};

document.getElementById("upload").onclick = async ()=>{
  preview.innerHTML = "";

  // garante que tÃ¡ tudo carregado
  await refresh();

  const u = await supabase.auth.getUser().catch(()=>({}));
  const user = u?.data?.user;

  if(!user){
    append("UPLOAD BLOQUEADO: nÃ£o logado.");
    return;
  }

  const file = document.getElementById("file").files[0];
  if(!file){
    append("UPLOAD BLOQUEADO: selecione um arquivo.");
    return;
  }

  const path = user.id + "/" + crypto.randomUUID() + "_" + safeName(file.name);
  append("UPLOAD START");
  append("PATH=" + path);

  const up = await supabase.storage.from(BUCKET).upload(path, file, { upsert: true });
  append("UPLOAD RESULT:");
  append(JSON.stringify(up, null, 2));
  append("");

  if(up.error){
    append("UPLOAD ERROR: " + up.error.message);
    return;
  }

  // ðŸ”¥ retry: evita "Object not found" por delay
  const signed = await createSignedUrlWithRetry(path, 600);

  if(signed.error){
    append("SIGNED ERROR (apÃ³s retries): " + signed.error.message);

    // fallback: tenta public url (sÃ³ funciona se bucket for pÃºblico)
    const pub = supabase.storage.from(BUCKET).getPublicUrl(path);
    append("PUBLIC URL (fallback):");
    append(JSON.stringify(pub, null, 2));

    if(pub?.data?.publicUrl){
      const a = document.createElement("a");
      a.href = pub.data.publicUrl;
      a.target = "_blank";
      a.innerText = "Abrir comprovante (public url)";
      preview.appendChild(a);
    }
    return;
  }

  const url = signed.data.signedUrl;
  append("SIGNED URL OK");
  append(url);

  if(file.type.startsWith("image")){
    const img = document.createElement("img");
    img.src = url;
    preview.appendChild(img);
  } else {
    const a = document.createElement("a");
    a.href = url;
    a.target="_blank";
    a.innerText="Abrir comprovante";
    preview.appendChild(a);
  }
};

await refresh();
supabase.auth.onAuthStateChange(async (event) => {
  append("AUTH STATE CHANGE: " + event);
  await refresh();
});
</script>
</body>
</html>
    







