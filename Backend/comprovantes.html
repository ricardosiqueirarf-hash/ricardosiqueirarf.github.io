<!DOCTYPE html>
<html lang="pt-br">
<head>
<meta charset="UTF-8">
<title>Upload de Comprovantes</title>
<meta name="viewport" content="width=device-width,initial-scale=1.0">
<style>
body{font-family:Arial;background:#f5f5f5;padding:40px}
.card{background:#fff;border-radius:12px;padding:24px;max-width:520px;margin:auto;box-shadow:0 0 30px rgba(0,0,0,.08)}
button{background:#1f6feb;color:#fff;border:none;padding:10px 18px;border-radius:8px;cursor:pointer}
button.sec{background:#111827}
.status{white-space:pre-wrap;margin-top:15px;font-size:13px;background:#f3f4f6;padding:10px;border-radius:10px}
img{max-width:100%;margin-top:15px;border-radius:8px}
a{display:inline-block;margin-top:12px}
</style>
</head>
<body>

<script>
  // FORÇA WWW (evita sessão sumir por origem diferente)
  if (location.hostname === "colorglassfortaleza.com.br") {
    location.replace("https://www.colorglassfortaleza.com.br" + location.pathname + location.search + location.hash);
  }
</script>

<div class="card">
  <h2>Enviar comprovante</h2>

  <button id="login">Entrar com GitHub</button>
  <button id="logout" class="sec">Logout</button>

  <p id="auth"></p>

  <input type="file" id="file" accept="image/*,application/pdf"><br><br>
  <button id="upload">Enviar</button>

  <p class="status" id="status"></p>
  <div id="preview"></div>
</div>

<script type="module">
import { createClient } from "https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/+esm";

const supabase = createClient(
  "https://hfhwvzldhgqniqnurync.supabase.co",
  "sb_publishable_0j-jqB63odD2yvugj7olMA_s18OwuPl",
  { auth: { persistSession: true, autoRefreshToken: true, detectSessionInUrl: true } }
);

const BUCKET = "comprovantes";
const REDIRECT = "https://www.colorglassfortaleza.com.br/callback.html";

const auth = document.getElementById("auth");
const status = document.getElementById("status");
const preview = document.getElementById("preview");

function safeName(n){
  return (n || "comprovante")
    .normalize("NFD")
    .replace(/[\u0300-\u036f]/g,"")
    .replace(/[^a-zA-Z0-9._-]/g,"_");
}

async function refresh(){
  status.innerText = ""; // limpa e mostra só o estado atual

  status.innerText += "REFRESH AUTH...\n";
  status.innerText += "HOST=" + location.host + "\n";
  status.innerText += "ORIGIN=" + location.origin + "\n\n";

  const keys = Object.keys(localStorage);
  const sbKeys = keys.filter(k => k.includes("sb-") || k.includes("supabase"));
  status.innerText += "LS KEYS:\n" + (sbKeys.length ? sbKeys.join("\n") : "(vazio)") + "\n\n";

  const sess = await supabase.auth.getSession();
  status.innerText += "getSession:\n" + JSON.stringify(sess, null, 2) + "\n\n";

  const u = await supabase.auth.getUser();
  status.innerText += "getUser:\n" + JSON.stringify(u, null, 2) + "\n\n";

  const user = u?.data?.user;

  if(user){
    auth.innerText = "Logado: " + (user.email || user.user_metadata?.user_name || user.id);
  } else {
    auth.innerText = "Não logado";
  }
}

document.getElementById("login").onclick = async ()=>{
  status.innerText = "CLICK LOGIN...\n";
  const { error } = await supabase.auth.signInWithOAuth({
    provider: "github",
    options: { redirectTo: REDIRECT }
  });
  if(error){
    status.innerText += "OAUTH ERROR:\n" + error.message;
    console.error(error);
    alert(error.message);
  } else {
    status.innerText += "REDIRECTING...\n";
  }
};

document.getElementById("logout").onclick = async ()=>{
  await supabase.auth.signOut();
  await refresh();
};

document.getElementById("upload").onclick = async ()=>{
  preview.innerHTML = "";

  const u = await supabase.auth.getUser();
  const user = u?.data?.user;

  if(!user){
    status.innerText = "Faça login";
    return;
  }

  const file = document.getElementById("file").files[0];
  if(!file){
    status.innerText = "Selecione um arquivo";
    return;
  }

  const path = user.id + "/" + crypto.randomUUID() + "_" + safeName(file.name);
  status.innerText = "Enviando...\nPATH=" + path + "\n";

  const up = await supabase.storage.from(BUCKET).upload(path, file);
  status.innerText += "UPLOAD RESULT:\n" + JSON.stringify(up, null, 2) + "\n\n";

  if(up.error){
    status.innerText += "UPLOAD ERROR:\n" + up.error.message;
    return;
  }

  const signed = await supabase.storage.from(BUCKET).createSignedUrl(path, 600);
  status.innerText += "SIGNED RESULT:\n" + JSON.stringify(signed, null, 2) + "\n\n";

  if(signed.error){
    status.innerText += "SIGNED ERROR:\n" + signed.error.message;
    return;
  }

  const url = signed.data.signedUrl;

  if(file.type.startsWith("image")){
    const img = document.createElement("img");
    img.src = url;
    preview.appendChild(img);
  } else {
    const a = document.createElement("a");
    a.href = url;
    a.target = "_blank";
    a.innerText = "Abrir comprovante";
    preview.appendChild(a);
  }
};

await refresh();
supabase.auth.onAuthStateChange(async () => {
  await refresh();
});
</script>
</body>
</html>






