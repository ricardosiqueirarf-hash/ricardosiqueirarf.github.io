<!DOCTYPE html>
<html lang="pt-br">
<head>
<meta charset="UTF-8">
<title>Upload de Comprovantes</title>
<meta name="viewport" content="width=device-width,initial-scale=1.0">
<style>
body{font-family:Arial;background:#f5f5f5;padding:40px}
.card{background:#fff;border-radius:12px;padding:24px;max-width:980px;margin:auto;box-shadow:0 0 30px rgba(0,0,0,.08)}
button{background:#1f6feb;color:#fff;border:none;padding:10px 18px;border-radius:8px;cursor:pointer}
button.sec{background:#111827}
button.warn{background:#b45309}
.status{white-space:pre-wrap;margin-top:15px;font-size:13px;background:#f3f4f6;padding:10px;border-radius:10px}
img{max-width:100%;margin-top:15px;border-radius:8px}
a{display:inline-block;margin-top:12px}
.row{display:flex;gap:10px;flex-wrap:wrap;align-items:center;margin-bottom:10px}
table{width:100%;border-collapse:collapse;margin-top:14px;background:#fff;border-radius:10px;overflow:hidden}
th,td{padding:10px;border-bottom:1px solid #e5e7eb;font-size:13px;text-align:left;vertical-align:top}
th{background:#f9fafb;font-weight:700}
.badge{display:inline-block;padding:2px 8px;border-radius:999px;background:#eef2ff;color:#1f6feb;font-size:12px}
.small{font-size:12px;color:#6b7280}
.actions{display:flex;gap:8px;flex-wrap:wrap}
input[type="file"]{max-width:100%}
</style>
</head>
<body>

<script>
  // FORÇA WWW (evita sessão sumir por origem diferente)
  if (location.hostname === "colorglassfortaleza.com.br") {
    location.replace("https://www.colorglassfortaleza.com.br" + location.pathname + location.search + location.hash);
  }
</script>

<div class="card">
  <h2>Enviar comprovante</h2>

  <div class="row">
    <button id="login">Entrar com GitHub</button>
    <button id="logout" class="sec">Logout</button>
    <button id="reset" class="warn" type="button">RESET AUTH</button>
    <button id="listar" type="button">Listar arquivos</button>
  </div>

  <p id="auth" class="small"></p>

  <div class="row">
    <input type="file" id="file" accept="image/*,application/pdf">
    <button id="upload">Enviar</button>
  </div>

  <div id="listaWrap"></div>

  <p class="status" id="status"></p>
</div>

<script type="module">
import { createClient } from "https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/+esm";

const SUPABASE_URL = "https://hfhwvzldhgqniqnurync.supabase.co";
const SUPABASE_ANON_KEY = "sb_publishable_0j-jqB63odD2yvugj7olMA_s18OwuPl";

const supabase = createClient(
  SUPABASE_URL,
  SUPABASE_ANON_KEY,
  { auth: { persistSession: true, autoRefreshToken: true, detectSessionInUrl: true } }
);

const BUCKET = "comprovantes";
const REDIRECT = "https://www.colorglassfortaleza.com.br/callback.html";

const auth = document.getElementById("auth");
const status = document.getElementById("status");
const listaWrap = document.getElementById("listaWrap");

function safeName(n){
  return (n || "comprovante")
    .normalize("NFD")
    .replace(/[\u0300-\u036f]/g,"")
    .replace(/[^a-zA-Z0-9._-]/g,"_");
}

function setStatus(txt){ status.innerText = txt || ""; }
function append(txt){ status.innerText += (txt || "") + "\n"; }

function sbLocalStorageInfo(){
  const keys = Object.keys(localStorage);
  const sbKeys = keys.filter(k => k.includes("sb-") || k.includes("supabase"));
  const tokenKey = sbKeys.find(k => k.includes("-auth-token")) || null;

  let raw = null, parsed = null, access_token = null;
  try {
    raw = tokenKey ? localStorage.getItem(tokenKey) : null;
    parsed = raw ? JSON.parse(raw) : null;
    access_token = parsed?.access_token || parsed?.currentSession?.access_token || null;
  } catch (e) {}

  return { sbKeys, tokenKey, access_token_exists: !!access_token, access_token };
}

window.addEventListener("unhandledrejection", (e) => {
  append("UNHANDLED REJECTION: " + (e?.reason?.message || e?.reason || e));
  console.error("unhandledrejection", e);
});
window.addEventListener("error", (e) => {
  append("WINDOW ERROR: " + (e?.message || e));
  console.error("window error", e);
});

async function manualAuthUserCheck(){
  const info = sbLocalStorageInfo();
  append("MANUAL CHECK: access_token exists? " + info.access_token_exists);

  if(!info.access_token){
    append("MANUAL CHECK: sem access_token no localStorage.");
    return;
  }

  try{
    const r = await fetch(`${SUPABASE_URL}/auth/v1/user`, {
      method: "GET",
      headers: {
        apikey: SUPABASE_ANON_KEY,
        Authorization: "Bearer " + info.access_token
      }
    });
    const txt = await r.text();
    append("MANUAL /auth/v1/user STATUS=" + r.status);
    append(txt);
  } catch (e) {
    append("MANUAL /auth/v1/user THROW: " + (e?.message || e));
    console.error("manual user throw", e);
  }
}

async function refresh(){
  setStatus("");

  append("REFRESH AUTH...");
  append("HOST=" + location.host);
  append("ORIGIN=" + location.origin);
  append("");

  const info = sbLocalStorageInfo();
  append("LS KEYS:");
  append(info.sbKeys.length ? info.sbKeys.join("\n") : "(vazio)");
  append("");
  append("TOKEN KEY: " + (info.tokenKey || "(nenhuma)"));
  append("ACCESS TOKEN EXISTS? " + info.access_token_exists);
  append("");

  try {
    const sess = await supabase.auth.getSession();
    append("getSession OK");
    append(JSON.stringify(sess, null, 2));
    append("");
  } catch (e) {
    append("getSession THROW: " + (e?.message || e));
    append("");
    console.error("getSession throw", e);
  }

  try {
    const u = await supabase.auth.getUser();
    append("getUser OK");
    append(JSON.stringify(u, null, 2));
    append("");
    const user = u?.data?.user;

    if(user){
      auth.innerText = "Logado: " + (user.email || user.user_metadata?.user_name || user.id);
    } else {
      auth.innerText = "Não logado";
    }
  } catch (e) {
    auth.innerText = "Não logado (erro getUser)";
    append("getUser THROW: " + (e?.message || e));
    append("");
    console.error("getUser throw", e);
  }

  await manualAuthUserCheck();
}

// ---------- LISTAGEM EM TABELA (NOVA FUNÇÃO) ----------
function bytesToHuman(bytes){
  if (bytes == null) return "-";
  const units = ["B","KB","MB","GB"];
  let i = 0;
  let v = Number(bytes);
  while (v >= 1024 && i < units.length-1){ v /= 1024; i++; }
  return (i === 0 ? v : v.toFixed(2)) + " " + units[i];
}

function escapeHtml(s){
  return String(s ?? "")
    .replaceAll("&","&amp;")
    .replaceAll("<","&lt;")
    .replaceAll(">","&gt;")
    .replaceAll('"',"&quot;")
    .replaceAll("'","&#039;");
}

async function openObject(path){
  // tenta signed url primeiro
  const signed = await supabase.storage.from(BUCKET).createSignedUrl(path, 600);
  if (!signed.error && signed.data?.signedUrl){
    window.open(signed.data.signedUrl, "_blank", "noopener");
    return;
  }

  // fallback: download blob e abre
  const dl = await supabase.storage.from(BUCKET).download(path);
  if (dl.error){
    append("OPEN ERROR (signed+download): " + dl.error.message);
    return;
  }

  const blobUrl = URL.createObjectURL(dl.data);
  window.open(blobUrl, "_blank", "noopener");
  // não revoga imediatamente pra não quebrar a aba
  setTimeout(() => URL.revokeObjectURL(blobUrl), 60_000);
}

async function listMyFiles(){
  // sem mexer no upload: isso só lista o destino
  await refresh();

  const u = await supabase.auth.getUser().catch(()=>({}));
  const user = u?.data?.user;
  if(!user){
    listaWrap.innerHTML = `<p class="small">Faça login para listar.</p>`;
    return;
  }

  const folder = user.id; // mesma pasta que você usa no upload: user.id/...

  append("LIST START folder=" + folder);

  // Lista arquivos da pasta do usuário
  const res = await supabase.storage.from(BUCKET).list(folder, {
    limit: 100,
    offset: 0,
    sortBy: { column: "updated_at", order: "desc" }
  });

  append("LIST RESULT:");
  append(JSON.stringify(res, null, 2));
  append("");

  if(res.error){
    listaWrap.innerHTML = `
      <p class="small" style="color:#b91c1c">
        Erro ao listar: ${escapeHtml(res.error.message)}<br>
        (Isso é policy de SELECT no storage.objects)
      </p>`;
    return;
  }

  const files = res.data || [];
  if(!files.length){
    listaWrap.innerHTML = `<p class="small">Nenhum arquivo encontrado em <b>${escapeHtml(folder)}/</b>.</p>`;
    return;
  }

  // Monta tabela
  let html = `
    <div class="row" style="justify-content:space-between;margin-top:16px">
      <div><span class="badge">Pasta</span> <b>${escapeHtml(folder)}/</b></div>
      <div class="small">${files.length} arquivo(s)</div>
    </div>

    <table>
      <thead>
        <tr>
          <th>Arquivo</th>
          <th>Tamanho</th>
          <th>Atualizado</th>
          <th>Tipo</th>
          <th>Ações</th>
        </tr>
      </thead>
      <tbody>
  `;

  for(const f of files){
    const name = f.name;
    const size = bytesToHuman(f.metadata?.size ?? f.metadata?.contentLength ?? null);
    const updated = f.updated_at || f.created_at || "";
    const mime = f.metadata?.mimetype || f.metadata?.contentType || "-";
    const fullPath = `${folder}/${name}`;

    html += `
      <tr>
        <td><b>${escapeHtml(name)}</b><div class="small">${escapeHtml(fullPath)}</div></td>
        <td>${escapeHtml(size)}</td>
        <td>${escapeHtml(updated)}</td>
        <td>${escapeHtml(mime)}</td>
        <td class="actions">
          <button type="button" data-open="${escapeHtml(fullPath)}">Abrir</button>
        </td>
      </tr>
    `;
  }

  html += `</tbody></table>`;
  listaWrap.innerHTML = html;

  // eventos dos botões
  listaWrap.querySelectorAll("button[data-open]").forEach(btn => {
    btn.addEventListener("click", async () => {
      const p = btn.getAttribute("data-open");
      append("OPEN: " + p);
      await openObject(p);
    });
  });
}

// ---------- BOTÕES ----------
document.getElementById("login").onclick = async ()=>{
  setStatus("CLICK LOGIN...\n");
  const { error } = await supabase.auth.signInWithOAuth({
    provider: "github",
    options: { redirectTo: REDIRECT }
  });
  if(error){
    append("OAUTH ERROR:");
    append(error.message);
    console.error(error);
    alert(error.message);
  } else {
    append("REDIRECTING...");
  }
};

document.getElementById("logout").onclick = async ()=>{
  await supabase.auth.signOut();
  listaWrap.innerHTML = "";
  await refresh();
};

document.getElementById("reset").onclick = async ()=>{
  setStatus("RESET AUTH...\n");
  try{ await supabase.auth.signOut(); } catch(e){}
  const keys = Object.keys(localStorage).filter(k => k.includes("sb-") || k.includes("supabase"));
  keys.forEach(k => localStorage.removeItem(k));
  append("REMOVIDAS KEYS:\n" + (keys.length ? keys.join("\n") : "(nenhuma)"));
  append("\nRELOAD...");
  location.reload();
};

document.getElementById("listar").onclick = async ()=>{
  await listMyFiles();
};

// ---------- UPLOAD (MANTIDO) ----------
document.getElementById("upload").onclick = async ()=>{
  // ⚠️ Não mexi no upload, só deixei como você tinha
  // (mantém o comportamento original)
  await refresh();

  const u = await supabase.auth.getUser().catch(()=>({}));
  const user = u?.data?.user;

  if(!user){
    append("UPLOAD BLOQUEADO: não logado.");
    return;
  }

  const file = document.getElementById("file").files[0];
  if(!file){
    append("UPLOAD BLOQUEADO: selecione um arquivo.");
    return;
  }

  const path = user.id + "/" + crypto.randomUUID() + "_" + safeName(file.name);
  append("UPLOAD START");
  append("PATH=" + path);

  const up = await supabase.storage.from(BUCKET).upload(path, file);
  append("UPLOAD RESULT:");
  append(JSON.stringify(up, null, 2));
  append("");

  if(up.error){
    append("UPLOAD ERROR: " + up.error.message);
    return;
  }

  const signed = await supabase.storage.from(BUCKET).createSignedUrl(path, 600);
  append("SIGNED RESULT:");
  append(JSON.stringify(signed, null, 2));
  append("");

  if(signed.error){
    append("SIGNED ERROR: " + signed.error.message);
    return;
  }

  append("SIGNED URL OK");
};

await refresh();
supabase.auth.onAuthStateChange(async (event) => {
  append("AUTH STATE CHANGE: " + event);
  await refresh();
});
</script>
</body>
</html>










