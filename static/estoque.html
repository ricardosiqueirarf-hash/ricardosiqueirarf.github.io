<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Disponibilidade de Produção | ColorGlass</title>
    <meta name="description" content="Disponibilidade de perfis e vidros para produção da ColorGlass.">

    <style>
        * { box-sizing: border-box; margin:0; padding:0; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; }
        body { background: #f5f7fa; color: #333; padding: 20px; }

        .container { max-width: 1200px; margin: 0 auto; }
        header { margin-bottom: 20px; }
        h1 { color: #1079ba; margin-bottom: 6px; }
        .subtitle { color: #5f6b7a; margin-bottom: 12px; }

        .menu {
            display: flex;
            justify-content: flex-start;
            gap: 10px;
            margin-bottom: 20px;
        }
        .menu button {
            padding: 10px 16px;
            background: #1079ba;
            color: #fff;
            border: none;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
        }
        .menu button:hover { background: #0d5d8c; transform: translateY(-2px); }

        .panel {
            background: #fff;
            padding: 18px 20px;
            border-radius: 12px;
            box-shadow: 0 6px 20px rgba(0,0,0,0.08);
            margin-bottom: 24px;
        }

        .legend {
            display: flex;
            flex-wrap: wrap;
            gap: 12px;
            align-items: center;
            font-weight: 600;
        }

        .legend-item {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            background: #f0f4fb;
            padding: 6px 10px;
            border-radius: 999px;
        }

        .status-dot {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            display: inline-block;
        }
        .status-dot--ok { background: #2ecc71; }
        .status-dot--warn { background: #f1c40f; }
        .status-dot--no { background: #e74c3c; }

        .status {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            padding: 6px 12px;
            border-radius: 999px;
            font-weight: 600;
            background: #f0f4fb;
        }

        .status--ok { color: #1e874b; }
        .status--warn { color: #b07d0a; }
        .status--no { color: #c0392b; }

        table {
            width: 100%;
            border-collapse: collapse;
            background: #fff;
            border-radius: 10px;
            overflow: hidden;
            box-shadow: 0 6px 18px rgba(0,0,0,0.08);
        }
        th, td { padding: 12px; text-align: center; border: 1px solid #dcdde1; }
        th { background: #1079ba; color: #fff; }
        tr:nth-child(even) { background: #f7f9fc; }
        tr:hover { background: #e6f0fa; }

        .section-title { margin: 14px 0 12px; color: #1079ba; }
        .empty-state {
            text-align: center;
            padding: 24px;
            color: #5f6b7a;
        }

        @media(max-width: 768px) {
            .menu { flex-direction: column; }
            th, td { font-size: 0.9rem; }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>Disponibilidade de Produção</h1>
            <p class="subtitle">Perfis e vidros prontos para produção com status atualizado.</p>
            <div class="menu">
                <button onclick="window.location.href='/'">Voltar</button>
                <button onclick="carregarTudo()">Atualizar lista</button>
            </div>
        </header>

        <section class="panel">
            <div class="legend">
                <span class="legend-item"><span class="status-dot status-dot--ok"></span>Disponível</span>
                <span class="legend-item"><span class="status-dot status-dot--warn"></span>Em falta</span>
                <span class="legend-item"><span class="status-dot status-dot--no"></span>Não temos</span>
            </div>
        </section>

        <section>
            <h2 class="section-title">Perfis de Alumínio</h2>
            <table>
                <thead>
                    <tr>
                        <th>Perfil</th>
                        <th>Tipologias</th>
                        <th>Insumos</th>
                        <th>Status</th>
                    </tr>
                </thead>
                <tbody id="tabela-perfis"></tbody>
            </table>
            <div id="empty-perfis" class="empty-state" hidden>Nenhum perfil disponível no momento.</div>
        </section>

        <section>
            <h2 class="section-title">Vidros</h2>
            <table>
                <thead>
                    <tr>
                        <th>Tipo</th>
                        <th>Espessura</th>
                        <th>Status</th>
                    </tr>
                </thead>
                <tbody id="tabela-vidros"></tbody>
            </table>
            <div id="empty-vidros" class="empty-state" hidden>Nenhum vidro disponível no momento.</div>
        </section>
    </div>

    <script>
        const API_BASE = "https://colorglass.onrender.com";

        const statusMap = {
            disponivel: { label: "Disponível", className: "status--ok", dot: "status-dot--ok" },
            em_falta: { label: "Em falta", className: "status--warn", dot: "status-dot--warn" },
            nao_tem: { label: "Não temos", className: "status--no", dot: "status-dot--no" }
        };

        function normalizeStatus(status) {
            if (!status) return "disponivel";
            const normalized = status
                .toString()
                .toLowerCase()
                .normalize("NFD")
                .replace(/[\u0300-\u036f]/g, "")
                .replace(/\s+/g, "_");
            if (normalized.includes("falta")) return "em_falta";
            if (normalized.includes("nao") || normalized.includes("sem")) return "nao_tem";
            return "disponivel";
        }

        function renderStatus(status) {
            const key = normalizeStatus(status);
            const config = statusMap[key] || statusMap.disponivel;
            return `
                <span class="status ${config.className}">
                    <span class="status-dot ${config.dot}"></span>
                    ${config.label}
                </span>
            `;
        }

        function preencherPerfis(perfis) {
            const tbody = document.getElementById("tabela-perfis");
            const empty = document.getElementById("empty-perfis");
            tbody.innerHTML = "";

            if (!perfis.length) {
                empty.hidden = false;
                return;
            }

            empty.hidden = true;
            perfis.forEach((perfil) => {
                const tr = document.createElement("tr");
                tr.innerHTML = `
                    <td>${perfil.nome}</td>
                    <td>${(perfil.tipologias || []).join(", ") || "-"}</td>
                    <td>${(perfil.insumos || []).join(", ") || "-"}</td>
                    <td>${renderStatus(perfil.status || perfil.disponibilidade)}</td>
                `;
                tbody.appendChild(tr);
            });
        }

        function preencherVidros(vidros) {
            const tbody = document.getElementById("tabela-vidros");
            const empty = document.getElementById("empty-vidros");
            tbody.innerHTML = "";

            if (!vidros.length) {
                empty.hidden = false;
                return;
            }

            empty.hidden = true;
            vidros.forEach((vidro) => {
                const tr = document.createElement("tr");
                tr.innerHTML = `
                    <td>${vidro.tipo}</td>
                    <td>${vidro.espessura} mm</td>
                    <td>${renderStatus(vidro.status || vidro.disponibilidade)}</td>
                `;
                tbody.appendChild(tr);
            });
        }

        async function carregarPerfis() {
            const resposta = await fetch(`${API_BASE}/api/perfis`);
            const perfis = await resposta.json();
            preencherPerfis(perfis);
        }

        async function carregarVidros() {
            const resposta = await fetch(`${API_BASE}/api/vidros`);
            const vidros = await resposta.json();
            preencherVidros(vidros);
        }

        async function carregarTudo() {
            await Promise.all([carregarPerfis(), carregarVidros()]);
        }

        window.addEventListener("DOMContentLoaded", () => {
            carregarTudo();
        });
    </script>
</body>
</html>
