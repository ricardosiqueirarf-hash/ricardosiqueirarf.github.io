<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Sistemas | ColorGlass</title>
<meta name="description" content="Gestão de sistemas da ColorGlass.">

<style>
/* RESET BÁSICO */
* { box-sizing: border-box; margin:0; padding:0; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; }
body { background: #f5f7fa; color: #333; padding: 20px; }

/* LAYOUT PRINCIPAL */
.container { max-width: 1200px; margin: 0 auto; }
header { margin-bottom: 20px; }
h1 { color: #1079ba; margin-bottom: 10px; }

/* MENU SUPERIOR */
.menu {
    display: flex;
    justify-content: flex-start;
    gap: 10px;
    margin-bottom: 20px;
}
.menu button {
    padding: 10px 16px;
    background: #1079ba;
    color: #fff;
    border: none;
    border-radius: 8px;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.2s ease;
}
.menu button:hover { background: #0d5d8c; transform: translateY(-2px); }

/* FORMULÁRIO */
.form-perfil {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 12px;
    background: #fff;
    padding: 20px;
    border-radius: 12px;
    box-shadow: 0 6px 20px rgba(0,0,0,0.1);
    margin-bottom: 30px;
}

/* INPUTS E SELECTS */
.form-perfil input,
.form-perfil select {
    padding: 6px 10px;
    font-size: 0.95rem;
    border-radius: 8px;
    border: 1px solid #ccc;
    width: 100%;
    transition: all 0.2s ease;
}

.form-perfil input:focus,
.form-perfil select:focus {
    border-color: #1079ba;
    box-shadow: 0 0 4px rgba(16,121,186,0.4);
    outline: none;
}

.preco-preview {
    display: flex;
    align-items: center;
    justify-content: center;
    background: #eef4fb;
    border-radius: 8px;
    padding: 8px 12px;
    font-weight: 600;
    color: #0d5d8c;
}

.trilhos-container {
    grid-column: 1 / -1;
    display: flex;
    flex-direction: column;
    gap: 6px;
    margin-top: 10px;
}

.trilhos-list {
    display: flex;
    flex-wrap: wrap;
    gap: 10px;
}

.trilho-item {
    background: #f0f4fb;
    padding: 6px 10px;
    border-radius: 8px;
    display: flex;
    align-items: center;
    gap: 6px;
    font-size: 0.95rem;
}

.trilho-item select { width: auto; }

/* BOTÕES GERAIS */
button {
    padding: 10px 16px;
    border-radius: 8px;
    border: none;
    cursor: pointer;
    background: #1079ba;
    color: #fff;
    font-weight: 600;
    transition: all 0.2s ease;
}
button:hover { background: #0d5d8c; transform: translateY(-2px); }
.btn-danger { background: #e84118; }
.btn-danger:hover { background: #c23616; transform: translateY(-2px); }

/* TABELA */
table {
    width: 100%;
    border-collapse: collapse;
    background: #fff;
    border-radius: 10px;
    overflow: hidden;
    box-shadow: 0 6px 18px rgba(0,0,0,0.08);
}
th, td { padding: 12px; text-align: center; border: 1px solid #dcdde1; }
th { background: #1079ba; color: #fff; }
tr:nth-child(even) { background: #f7f9fc; }
tr:hover { background: #e6f0fa; }

/* RESPONSIVO */
@media(max-width: 768px) {
    .form-perfil { grid-template-columns: 1fr; }
    .menu { flex-direction: column; }
    .trilhos-list { flex-direction: column; }
}
</style>
</head>
<body>
<div class="container">
    <header>
        <h1>Sistemas</h1>
        <div class="menu">
            <button onclick="window.location.href='/'">Voltar</button>
            <button onclick="salvar()">Salvar</button>
            <button onclick="cancelar()">Cancelar</button>
        </div>
    </header>

    <section class="form-perfil">
        <input type="hidden" id="sistema_id">
        <input id="nome" placeholder="Nome">
        <input id="custo" type="number" step="0.01" placeholder="Custo">
        <input id="margem" type="number" step="0.01" placeholder="Margem %">
        <div class="preco-preview" id="precoPreview">Preço final: R$ 0,00</div>

        <div class="trilhos-container">
            <h4>Trilhos superiores</h4>
            <div id="trilhos-superiores" class="trilhos-list">
                <div class="trilho-item">
                    <select class="trilho-select" data-group="superior"></select>
                    <button type="button" onclick="adicionarTrilho('trilhos-superiores', 'superior')">+</button>
                </div>
            </div>
        </div>

        <div class="trilhos-container">
            <h4>Trilhos inferiores</h4>
            <div id="trilhos-inferiores" class="trilhos-list">
                <div class="trilho-item">
                    <select class="trilho-select" data-group="inferior"></select>
                    <button type="button" onclick="adicionarTrilho('trilhos-inferiores', 'inferior')">+</button>
                </div>
            </div>
        </div>
    </section>

    <section>
        <table>
            <thead>
                <tr>
                    <th>Nome</th>
                    <th>Custo</th>
                    <th>Margem</th>
                    <th>Preço Final</th>
                    <th>Trilhos superiores</th>
                    <th>Trilhos inferiores</th>
                    <th>Ações</th>
                </tr>
            </thead>
            <tbody id="tabela"></tbody>
        </table>
    </section>
</div>

<script>
const FALLBACK_API_URL = "https://colorglass.onrender.com";
const API_HOSTS_WITH_BACKEND = new Set(["localhost", "127.0.0.1", "colorglass.onrender.com"]);
const BASE_URL = API_HOSTS_WITH_BACKEND.has(window.location.hostname)
    ? window.location.origin
    : FALLBACK_API_URL;

let trilhosLista = [];

async function carregarTrilhos() {
    try {
        const data = await fetchJson(`${BASE_URL}/api/trilhos`);
        trilhosLista = data.map((trilho) => trilho.nome);
        atualizarSelects();
    } catch (error) {
        console.error("Erro ao carregar trilhos:", error);
        alert("Não foi possível carregar os trilhos. Verifique o endereço da API.");
    }
}

async function fetchJson(url, options = {}) {
    const res = await fetch(url, options);
    if (!res.ok) {
        const errorText = await res.text();
        throw new Error(`Erro ${res.status}: ${errorText || res.statusText}`);
    }
    return res.json();
}

function atualizarSelects() {
    document.querySelectorAll(".trilho-select").forEach((select) => {
        const valorAtual = select.value;
        select.innerHTML = "<option value=''>--Selecione--</option>";
        trilhosLista.forEach((trilho) => {
            const opt = document.createElement("option");
            opt.value = trilho;
            opt.textContent = trilho;
            select.appendChild(opt);
        });
        select.value = valorAtual;
    });
}

function adicionarTrilho(containerId, group) {
    const container = document.getElementById(containerId);
    const novoItem = document.createElement("div");
    novoItem.className = "trilho-item";
    novoItem.innerHTML = `
        <select class="trilho-select" data-group="${group}"></select>
        <button type="button" onclick="adicionarTrilho('${containerId}', '${group}')">+</button>
        <button type="button" onclick="removerTrilho(this)">-</button>
    `;
    container.appendChild(novoItem);
    atualizarSelects();
}

function removerTrilho(botao) {
    botao.parentElement.remove();
}

function getTrilhosSelecionados(group) {
    return Array.from(document.querySelectorAll(`.trilho-select[data-group="${group}"]`))
        .map((select) => select.value)
        .filter(Boolean);
}

async function carregar() {
    let data = [];
    try {
        data = await fetchJson(`${BASE_URL}/api/sistemas`);
    } catch (error) {
        console.error("Erro ao carregar sistemas:", error);
        alert("Não foi possível carregar os sistemas. Verifique o endereço da API.");
    }

    const tbody = document.getElementById("tabela");
    tbody.innerHTML = "";

    data.forEach((sistema) => {
        const tr = document.createElement("tr");
        tr.innerHTML = `
            <td>${sistema.nome}</td>
            <td>R$ ${Number(sistema.custo).toFixed(2)}</td>
            <td>${Number(sistema.margem).toFixed(2)}%</td>
            <td><b>R$ ${Number(sistema.preco).toFixed(2)}</b></td>
            <td>${(sistema.trilhossup || []).join(", ")}</td>
            <td>${(sistema.trilhosinf || []).join(", ")}</td>
            <td>
                <button onclick='editar(${JSON.stringify(sistema)})'>Editar</button>
                <button onclick="excluir('${sistema.id}')">Excluir</button>
            </td>
        `;
        tbody.appendChild(tr);
    });
}

const nomeInput = document.getElementById("nome");
const custoInput = document.getElementById("custo");
const margemInput = document.getElementById("margem");
const sistemaId = document.getElementById("sistema_id");
const precoPreview = document.getElementById("precoPreview");

function atualizarPrecoPreview() {
    const custo = parseFloat(custoInput.value) || 0;
    const margem = parseFloat(margemInput.value) || 0;
    const preco = custo * (1 + margem / 100);
    precoPreview.textContent = `Preço final: R$ ${preco.toFixed(2)}`;
    return preco;
}

async function salvar() {
    const id = sistemaId.value;
    const nome = nomeInput.value;
    const custo = parseFloat(custoInput.value);
    const margem = parseFloat(margemInput.value);
    const preco = atualizarPrecoPreview();
    const trilhossup = getTrilhosSelecionados("superior");
    const trilhosinf = getTrilhosSelecionados("inferior");

    if (!nome || isNaN(custo) || isNaN(margem)) {
        alert("Preencha todos os campos corretamente");
        return;
    }

    const payload = { nome, custo, margem, preco, trilhossup, trilhosinf };
    const url = id ? `${BASE_URL}/api/sistemas/${id}` : `${BASE_URL}/api/sistemas`;
    const method = id ? "PUT" : "POST";

    try {
        await fetchJson(url, {
            method,
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(payload)
        });
    } catch (error) {
        console.error("Erro ao salvar sistema:", error);
        alert("Não foi possível salvar o sistema. Verifique o endereço da API.");
        return;
    }

    cancelar();
    carregar();
}

function editar(sistema) {
    sistemaId.value = sistema.id;
    nomeInput.value = sistema.nome;
    custoInput.value = sistema.custo;
    margemInput.value = sistema.margem;
    atualizarPrecoPreview();

    const superiores = sistema.trilhossup?.length ? sistema.trilhossup : [""];
    const inferiores = sistema.trilhosinf?.length ? sistema.trilhosinf : [""];

    const containerSuperior = document.getElementById("trilhos-superiores");
    containerSuperior.innerHTML = "";
    superiores.forEach(() => {
        const div = document.createElement("div");
        div.className = "trilho-item";
        div.innerHTML = `
            <select class="trilho-select" data-group="superior"></select>
            <button type="button" onclick="adicionarTrilho('trilhos-superiores', 'superior')">+</button>
            <button type="button" onclick="removerTrilho(this)">-</button>
        `;
        containerSuperior.appendChild(div);
    });

    const containerInferior = document.getElementById("trilhos-inferiores");
    containerInferior.innerHTML = "";
    inferiores.forEach(() => {
        const div = document.createElement("div");
        div.className = "trilho-item";
        div.innerHTML = `
            <select class="trilho-select" data-group="inferior"></select>
            <button type="button" onclick="adicionarTrilho('trilhos-inferiores', 'inferior')">+</button>
            <button type="button" onclick="removerTrilho(this)">-</button>
        `;
        containerInferior.appendChild(div);
    });

    atualizarSelects();

    document.querySelectorAll('.trilho-select[data-group="superior"]')
        .forEach((select, index) => {
            select.value = sistema.trilhossup?.[index] || "";
        });

    document.querySelectorAll('.trilho-select[data-group="inferior"]')
        .forEach((select, index) => {
            select.value = sistema.trilhosinf?.[index] || "";
        });
}

async function excluir(id) {
    if (!confirm("Excluir este sistema?")) return;
    try {
        await fetchJson(`${BASE_URL}/api/sistemas/${id}`, { method: "DELETE" });
        carregar();
    } catch (error) {
        console.error("Erro ao excluir sistema:", error);
        alert("Não foi possível excluir o sistema. Verifique o endereço da API.");
    }
}

function cancelar() {
    sistemaId.value = "";
    nomeInput.value = "";
    custoInput.value = "";
    margemInput.value = "";
    atualizarPrecoPreview();

    document.getElementById("trilhos-superiores").innerHTML = `
        <div class="trilho-item">
            <select class="trilho-select" data-group="superior"></select>
            <button type="button" onclick="adicionarTrilho('trilhos-superiores', 'superior')">+</button>
        </div>
    `;

    document.getElementById("trilhos-inferiores").innerHTML = `
        <div class="trilho-item">
            <select class="trilho-select" data-group="inferior"></select>
            <button type="button" onclick="adicionarTrilho('trilhos-inferiores', 'inferior')">+</button>
        </div>
    `;

    atualizarSelects();
}

window.addEventListener("DOMContentLoaded", () => {
    ["input", "change"].forEach((eventType) => {
        custoInput.addEventListener(eventType, atualizarPrecoPreview);
        margemInput.addEventListener(eventType, atualizarPrecoPreview);
    });
    atualizarPrecoPreview();
    carregarTrilhos();
    carregar();
});
</script>
</body>
</html>
