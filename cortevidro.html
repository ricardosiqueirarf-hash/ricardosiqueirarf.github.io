<!DOCTYPE html>
<html lang="pt-br">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Corte de Vidro | ColorGlass</title>
<style>
body { font-family: Arial, sans-serif; background: #f2f2f2; margin:0; padding:0;}
.container { padding: 20px; max-width: 900px; margin:auto; }
h1 { text-align:center; }
label { display:block; margin:10px 0 5px; }
input { padding:5px; width: 100px; margin-right:10px; }
button { padding:7px 14px; margin-top:10px; cursor:pointer; }
#cortesLista div { background:#fff; padding:10px; margin-bottom:10px; border-radius:5px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
#resultado { margin-top:20px; padding:10px; background:#fff; border-radius:5px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
svg { border:1px solid #333; margin-top:10px; }
</style>
</head>
<body>
<div class="container">
<h1>Corte de Vidro</h1>

<h2>Adicionar Corte</h2>
<label>Largura (mm) <input type="number" id="largura"></label>
<label>Altura (mm) <input type="number" id="altura"></label>
<label>Espessura (mm) <input type="number" id="espessura" value="8"></label>
<label>Tipo de Vidro 
<select id="tipoVidro">
    <option value="comum">Comum</option>
    <option value="temperado">Temperado</option>
    <option value="laminado">Laminado</option>
</select>
</label>
<button onclick="adicionarCorte()">Adicionar Corte</button>

<h2>Cortes Adicionados</h2>
<div id="cortesLista"></div>

<button onclick="calcularCortes()">Calcular Melhor Distribuição</button>

<div id="resultado"></div>
<svg id="svgCorte" width="800" height="1000"></svg>
</div>

<script>
const cortes = [];

function adicionarCorte(){
    const largura = +document.getElementById('largura').value;
    const altura = +document.getElementById('altura').value;
    const espessura = +document.getElementById('espessura').value;
    const tipoVidro = document.getElementById('tipoVidro').value;

    if(!largura || !altura || !espessura) return alert("Preencha todas as dimensões.");

    cortes.push({largura, altura, espessura, tipoVidro});
    renderCortes();
}

function renderCortes(){
    const container = document.getElementById('cortesLista');
    container.innerHTML = '';
    cortes.forEach((c, idx)=>{
        container.innerHTML += `<div>
            Corte ${idx+1}: ${c.largura}x${c.altura} mm - ${c.tipoVidro} 
            <button onclick="removerCorte(${idx})">Remover</button>
        </div>`;
    });
}

function removerCorte(idx){
    cortes.splice(idx,1);
    renderCortes();
}

async function calcularCortes(){
    if(cortes.length===0) return alert("Adicione pelo menos um corte.");

    try{
        // Preparar array compatível com a API
        const pecasEnviar = cortes.map(c => ({
            largura: c.largura,
            altura: c.altura,
            quantidade: 1,
            tipoVidro: c.tipoVidro,
            insumos: {}
        }));

        const res = await fetch('https://colorglass.onrender.com/api/cortevidro', {
            method:'POST',
            headers:{'Content-Type':'application/json'},
            body:JSON.stringify({ pecas: pecasEnviar })
        });
        const data = await res.json();

        if(!data.success) return alert(data.error || "Erro ao calcular cortes.");

        const resultadoDiv = document.getElementById('resultado');
        resultadoDiv.innerHTML = `<h3>Resultado do Corte</h3>`;
        let totalCusto = 0;
        let perdaPercent = data.perda_percent;

        data.pecas.forEach((c,i)=>{
            totalCusto += c.custo;
            resultadoDiv.innerHTML += `<p>Corte ${i+1}: ${c.largura}x${c.altura} mm, Tipo: ${c.tipo_vidro}, Custo: R$ ${c.custo.toFixed(2)}</p>`;
        });
        resultadoDiv.innerHTML += `<strong>Total Custo: R$ ${totalCusto.toFixed(2)}, Perda: ${perdaPercent}%</strong>`;

        desenharSVG(data.pecas);

    } catch(err){
        console.error(err);
        alert("Erro ao calcular cortes. Veja o console.");
    }
}

function desenharSVG(cortesCalculados){
    const svg = document.getElementById('svgCorte');
    svg.innerHTML = '';
    const chapaWidth = 2400;
    const chapaHeight = 3210;
    const scale = Math.min(800/chapaWidth, 1000/chapaHeight);

    // Chapa
    svg.innerHTML = `<rect x="0" y="0" width="${chapaWidth*scale}" height="${chapaHeight*scale}" fill="#ddd" stroke="#000" stroke-width="2"/>`;

    let offsetX=0, offsetY=0, rowHeight=0;
    cortesCalculados.forEach(c=>{
        const w = c.largura*scale;
        const h = c.altura*scale;
        if(offsetX + w > chapaWidth*scale){
            offsetX=0;
            offsetY+=rowHeight;
            rowHeight=0;
        }
        svg.innerHTML += `<rect x="${offsetX}" y="${offsetY}" width="${w}" height="${h}" fill="#9cf" stroke="#000" stroke-width="1"/>`;
        offsetX += w;
        rowHeight = Math.max(rowHeight,h);
    });
}
</script>
</body>
</html>

