<!DOCTYPE html>
<html lang="pt-br">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Portas de Vidro e Alum√≠nio em Fortaleza | ColorGlass</title>
<meta name="description" content="Portas de vidro e alum√≠nio sob medida em Fortaleza. Or√ßamento r√°pido, qualidade premium e instala√ß√£o profissional.">
<meta name="robots" content="index, follow">

<!-- SEO LOCAL -->
<meta name="geo.region" content="BR-CE">
<meta name="geo.placename" content="Fortaleza">
<meta name="geo.position" content="-3.7319;-38.5267">
<meta name="ICBM" content="-3.7319, -38.5267">

<!-- CANONICAL -->
<link rel="canonical" href="https://www.colorglassfortaleza.com.br/">

<!-- OPEN GRAPH -->
<meta property="og:title" content="Portas de Vidro e Alum√≠nio em Fortaleza | ColorGlass">
<meta property="og:description" content="Or√ßamento r√°pido em portas de vidro e alum√≠nio sob medida em Fortaleza. Qualidade premium e instala√ß√£o profissional.">
<meta property="og:url" content="https://www.colorglassfortaleza.com.br/">
<meta property="og:type" content="website">

<style>
body { margin:0; font-family:Arial, Helvetica, sans-serif; background:#f2f2f2; }
.app { display:grid; grid-template-columns:18% 82%; height:100vh; }
.sidebar { background:#1e1e1e; color:white; padding:20px; display:flex; flex-direction:column; gap:10px; }
.sidebar button { padding:10px; border:none; background:#333; color:white; border-radius:6px; cursor:pointer; }
.content { padding:25px; overflow-y:auto; height:100vh; }
label { display:flex; flex-direction:column; font-size:0.9rem; width:180px; margin-bottom:8px;}
input, select { padding:7px; margin-top:5px; }
.btn { padding:10px 16px; border:none; border-radius:6px; cursor:pointer; background:#0078d7; color:white; margin-top:10px; }
.btn-danger { background:#c0392b; }
#formCliente { background:white; padding:15px; border-radius:8px; margin-bottom:20px; box-shadow:0 2px 8px rgba(0,0,0,.1); }
#portasSalvas div { margin-bottom:10px; border:1px solid #333; padding:10px; background:#f0f0f0; }
table { border-collapse: collapse; width:100%; margin-top:10px; }
th, td { border:1px solid #ccc; padding:5px; text-align:left; }
th { background:#ddd; }
#portaSVG { width:100%; height:400px; border:1px solid #333; background:white; }

.door-layout {
    display: grid;
    grid-template-columns: minmax(280px, 420px) 1fr;
    gap: 20px;
    align-items: start;
    margin-top: 10px;
}

.door-form {
    display: flex;
    flex-direction: column;
    gap: 10px;
}

.door-preview {
    background: #fff;
    padding: 12px;
    border-radius: 8px;
    box-shadow: 0 2px 8px rgba(0,0,0,.08);
}

.price-preview {
    background: #eef4fb;
    color: #0d5d8c;
    font-weight: 600;
    padding: 8px 12px;
    border-radius: 6px;
}

.cost-toggle {
    display: flex;
    align-items: center;
    gap: 8px;
    font-size: 0.9rem;
}

.cost-details {
    background: #fff;
    border-radius: 8px;
    padding: 12px;
    box-shadow: 0 2px 8px rgba(0,0,0,.08);
    font-size: 0.9rem;
}

.cost-details table {
    width: 100%;
    border-collapse: collapse;
    margin-top: 8px;
}

.cost-details th,
.cost-details td {
    border: 1px solid #ddd;
    padding: 6px;
    text-align: left;
}

.cost-details th {
    background: #f0f4fb;
}

@media (max-width: 1024px) {
    .app { grid-template-columns: 1fr; }
    .sidebar { flex-direction: row; flex-wrap: wrap; }
    .door-layout { grid-template-columns: 1fr; }
}
</style>

<link id="tema-css" rel="stylesheet" href="">
<script>
if(localStorage.getItem("darkmode") === "true"){
    document.getElementById("tema-css").href = "/static/css/indexdark.css";
}
</script>
</head>

<body>
<div class="app">
    <div class="sidebar">
        <h3>ColorGlass</h3>
        <button onclick="go('perfis.html')">Perfis</button>
        <button onclick="go('vidros.html')">Vidros</button>
        <button onclick="go('producao.html')">Produ√ß√£o</button>
        <button onclick="go('insumos.html')">Insumos</button>
        <button onclick="go('catalogo.html')">Cat√°logo</button>
        <button onclick="go('ajustes.html')">Ajustes</button>
    </div>

    <div class="content">
        <h1>Or√ßamento de Portas</h1>

        <div id="infoOrcamento" style="margin-bottom:15px;"></div>

        <div class="door-layout">
            <div class="door-form">
                <label>Tipologia
                    <select id="tipologia" onchange="renderCampos()">
                        <option value="">Selecione</option>
                        <option value="giro">Giro</option>
                        <option value="deslizante">Deslizante</option>
                        <option value="correr">Correr</option>
                        <option value="pivotante">Pivotante</option>
                    </select>
                </label>

                <button class="btn" onclick="abrirEstrutura3D()" style="margin-top:10px;">
            üß± Or√ßar Estrutura 3D
                </button>

                <label>Quantidade<input type="number" id="quantidade" value="1" min="1" onchange="atualizarPrecoPorta()"></label>

                <div id="campos"></div>
                <div class="price-preview" id="precoPorta">Pre√ßo estimado: R$ 0,00</div>
                <label class="cost-toggle">
                    <input type="checkbox" id="toggleCustos" onchange="toggleDetalhesCustos()">
                    Mostrar custos e pre√ßos detalhados
                </label>
                <div class="cost-details" id="detalhesCustos" style="display: none;"></div>
                <button class="btn" onclick="salvarPorta()">Salvar Porta</button>
            </div>

            <div class="door-preview">
                <svg id="portaSVG"></svg>
            </div>
        </div>

        <h2>Portas Salvas</h2>
        <div id="portasSalvas"></div>

        <h2>Estruturas 3D Salvas</h2>
        <div id="estruturas3DSalvas"></div>

        <button class="btn" onclick="finalizarOrcamento()" style="margin-top:20px;">
            Finalizar Or√ßamento
        </button>
    </div>
</div>

<script>
function go(p){ window.location.href = p }

// =====================
// BACKEND
// =====================
const API_BASE = "https://colorglass.onrender.com";

// =====================
// UUID DO OR√áAMENTO
// =====================
const params = new URLSearchParams(window.location.search)
const ORCAMENTO_UUID = params.get("orcamento_uuid")
if(!ORCAMENTO_UUID){
    document.getElementById("infoOrcamento").innerHTML =
        "<strong style='color:red'>UUID do or√ßamento n√£o encontrado</strong>"
    throw new Error("orcamento_uuid ausente")
}
document.getElementById("infoOrcamento").innerHTML =
    `Editando or√ßamento: <strong>${ORCAMENTO_UUID}</strong>`

// =====================
// TIPOLOGIAS
// =====================
const TIPOLOGIAS = {
    giro: ["largura","altura","perfil","vidro","dobradica"],
    deslizante: ["largura","altura","perfil","vidro","trilho"],
    correr: ["largura","altura","perfil","vidro","trilho"],
    pivotante: ["largura","altura","perfil","vidro","pivo"]
}

// =====================
// DADOS
// =====================
let todosPerfis = []
let todosVidros = []
let todosInsumos = []

async function carregarPerfis() {
    const res = await fetch(`${API_BASE}/api/perfis`)
    todosPerfis = await res.json()
    atualizarPerfisSelect()
}

async function carregarVidros() {
    const res = await fetch(`${API_BASE}/api/vidros`)
    todosVidros = await res.json()
    atualizarVidrosSelect()
}

async function carregarInsumos() {
    const res = await fetch(`${API_BASE}/api/materiais`)
    todosInsumos = await res.json()
    atualizarDetalhesCusto()
}

function atualizarPerfisSelect() {
    const tipo = document.getElementById("tipologia").value
    const perfilSelect = document.getElementById("perfil")
    if(!perfilSelect) return
    perfilSelect.innerHTML = "<option value=''>Selecione</option>"
    todosPerfis.filter(p => p.tipologias.includes(tipo))
        .forEach(p => {
            perfilSelect.innerHTML += `<option value="${p.id}">${p.nome} - R$ ${p.preco}/m</option>`
        })
}

function atualizarVidrosSelect() {
    const vidroSelect = document.getElementById("vidro")
    if(!vidroSelect) return
    vidroSelect.innerHTML = "<option value=''>Selecione</option>"
    todosVidros.forEach(v => {
        vidroSelect.innerHTML += `<option value="${v.id}">${v.tipo} ${v.espessura || ""}mm - R$ ${v.preco}/m¬≤</option>`
    })
}

// =====================
// PRE√áO
// =====================
function calcularPrecoPorta(){
    const largura = (+document.getElementById("largura")?.value || 0)/1000
    const altura = (+document.getElementById("altura")?.value || 0)/1000
    const perfil = todosPerfis.find(p=>p.id==document.getElementById("perfil")?.value)
    const vidro = todosVidros.find(v=>v.id==document.getElementById("vidro")?.value)
    const quantidade = +document.getElementById("quantidade")?.value || 1

    let total = 0
    if(perfil) total += perfil.preco * 2 * (largura + altura)
    if(vidro) total += vidro.preco * largura * altura

    return total * quantidade
}

function atualizarPrecoPorta(){
    const preco = calcularPrecoPorta()
    const precoEl = document.getElementById("precoPorta")
    if (precoEl) {
        precoEl.textContent = `Pre√ßo estimado: R$ ${preco.toFixed(2)}`
    }
    atualizarDetalhesCusto()
}

function toggleDetalhesCustos() {
    const detalhes = document.getElementById("detalhesCustos")
    const toggle = document.getElementById("toggleCustos")
    if (!detalhes || !toggle) return
    detalhes.style.display = toggle.checked ? "block" : "none"
    if (toggle.checked) {
        atualizarDetalhesCusto()
    }
}

function formatarMoeda(valor) {
    return `R$ ${Number(valor).toFixed(2)}`
}

function atualizarDetalhesCusto() {
    const detalhes = document.getElementById("detalhesCustos")
    const toggle = document.getElementById("toggleCustos")
    if (!detalhes || !toggle || !toggle.checked) return

    const largura = (+document.getElementById("largura")?.value || 0) / 1000
    const altura = (+document.getElementById("altura")?.value || 0) / 1000
    const quantidade = +document.getElementById("quantidade")?.value || 1
    const perimetro = 2 * (largura + altura)

    const perfil = todosPerfis.find(p => p.id == document.getElementById("perfil")?.value)
    const vidro = todosVidros.find(v => v.id == document.getElementById("vidro")?.value)
    const insumos = (perfil?.insumos || [])
        .map((nome) => todosInsumos.find((insumo) => insumo.nome === nome))
        .filter(Boolean)

    if (!perfil && !vidro && insumos.length === 0) {
        detalhes.innerHTML = "<em>Selecione perfil, vidro e tipologia para ver os custos.</em>"
        return
    }

    const linhas = []
    let custoTotal = 0
    let precoTotal = 0

    if (perfil) {
        const custoPerfil = (perfil.custo || 0) * perimetro
        const precoPerfil = (perfil.preco || 0) * perimetro
        custoTotal += custoPerfil
        precoTotal += precoPerfil
        linhas.push({
            item: `Perfil (${perfil.nome})`,
            quantidade: `${perimetro.toFixed(2)} m`,
            custo: custoPerfil,
            preco: precoPerfil
        })
    }

    if (vidro) {
        const area = largura * altura
        const custoVidro = (vidro.custo || 0) * area
        const precoVidro = (vidro.preco || 0) * area
        custoTotal += custoVidro
        precoTotal += precoVidro
        linhas.push({
            item: `Vidro (${vidro.tipo})`,
            quantidade: `${area.toFixed(2)} m¬≤`,
            custo: custoVidro,
            preco: precoVidro
        })
    }

    insumos.forEach((insumo) => {
        const tipo = insumo.tipo_medida
        let quantidadeInsumo = 0
        if (tipo === "metro_linear") {
            quantidadeInsumo = perimetro
        } else if (tipo === "unidade") {
            quantidadeInsumo = quantidade
        } else {
            return
        }

        const custoInsumo = (insumo.custo || 0) * quantidadeInsumo
        const precoInsumo = (insumo.preco || 0) * quantidadeInsumo
        custoTotal += custoInsumo
        precoTotal += precoInsumo
        linhas.push({
            item: `Insumo (${insumo.nome})`,
            quantidade: tipo === "metro_linear"
                ? `${quantidadeInsumo.toFixed(2)} m`
                : `${quantidadeInsumo} un`,
            custo: custoInsumo,
            preco: precoInsumo
        })
    })

    detalhes.innerHTML = `
        <strong>Detalhamento de custos e pre√ßos</strong>
        <table>
            <thead>
                <tr>
                    <th>Item</th>
                    <th>Quantidade</th>
                    <th>Custo</th>
                    <th>Pre√ßo</th>
                </tr>
            </thead>
            <tbody>
                ${linhas.map((linha) => `
                    <tr>
                        <td>${linha.item}</td>
                        <td>${linha.quantidade}</td>
                        <td>${formatarMoeda(linha.custo)}</td>
                        <td>${formatarMoeda(linha.preco)}</td>
                    </tr>
                `).join("")}
            </tbody>
            <tfoot>
                <tr>
                    <th colspan="2">Totais</th>
                    <th>${formatarMoeda(custoTotal)}</th>
                    <th>${formatarMoeda(precoTotal)}</th>
                </tr>
            </tfoot>
        </table>
    `
}

// =====================
// RENDER CAMPOS
// =====================
function renderCampos(){
    const tipo = document.getElementById("tipologia").value
    const container = document.getElementById("campos")
    container.innerHTML=""
    if(!TIPOLOGIAS[tipo]) return

    TIPOLOGIAS[tipo].forEach(c=>{
        const map={
            largura:`Largura (mm)<input id="largura" type="number" value="800" oninput="desenharPorta(); atualizarPrecoPorta()">`,
            altura:`Altura (mm)<input id="altura" type="number" value="2000" oninput="desenharPorta(); atualizarPrecoPorta()">`,
            perfil:`Perfil<select id="perfil" onchange="atualizarPrecoPorta()"></select>`,
            vidro:`Vidro<select id="vidro" onchange="atualizarPrecoPorta()"></select>`,
            trilho:`Trilho<select><option>Padr√£o</option></select>`,
            dobradica:`Dobradi√ßa<select><option>Padr√£o</option></select>`,
            pivo:`Piv√¥<select><option>Superior</option></select>`
        }
        container.innerHTML += `<label>${map[c]}</label>`
    })

    desenharPorta()
    atualizarPerfisSelect()
    atualizarVidrosSelect()
    atualizarPrecoPorta()
}

// =====================
// SVG
// =====================
function desenharPorta(){
    const svg = document.getElementById("portaSVG")
    const w = +document.getElementById("largura")?.value
    const h = +document.getElementById("altura")?.value
    if(!w||!h) return
    svg.innerHTML=""
    const scale = Math.min(200/w, 380/h)
    svg.innerHTML = `<rect x="10" y="10" width="${w*scale}" height="${h*scale}" fill="#ccc" stroke="#000" stroke-width="6"/>`
}

// =====================
// PORTAS LOCAL
// =====================
let portas=[], editando=null, idCounter=0
const draftKey = `portas_draft_${ORCAMENTO_UUID}`

function salvarPorta(){
    const tipo = document.getElementById("tipologia").value
    if(!tipo) return alert("Selecione a tipologia")

    const dados = {}
    TIPOLOGIAS[tipo].forEach(c=>{
        const el = document.getElementById(c)
        if(el) dados[c] = el.value
    })
    const quantidade = +document.getElementById("quantidade")?.value || 1

    const porta = {
        id: editando ?? idCounter++,
        tipo,
        dados,
        quantidade,
        preco: calcularPrecoPorta(),
        svg: portaSVG.outerHTML
    }
    editando === null ? portas.push(porta) : Object.assign(portas.find(p=>p.id===editando), porta)
    editando = null
    renderPortas()
}

function renderPortas(){
    const c = document.getElementById("portasSalvas")
    c.innerHTML = ""
    portas.forEach((p, idx)=>{
        const perfilNome = todosPerfis.find(perfil => perfil.id == p.dados.perfil)?.nome || "Perfil n√£o definido"
        const vidroNome = todosVidros.find(vidro => vidro.id == p.dados.vidro)?.tipo || "Vidro n√£o definido"
        c.innerHTML += `
            <div>
                <strong>${idx+1}. ${p.tipo}</strong><br>
                Quantidade: ${p.quantidade}<br>
                Perfil: ${perfilNome}<br>
                Vidro: ${vidroNome}<br>
                Pre√ßo: R$ ${p.preco.toFixed(2)}<br>
                ${p.svg}<br>
                <button class="btn" onclick="editarPorta(${p.id})">Editar</button>
                <button class="btn btn-danger" onclick="apagarPorta(${p.id})">Apagar</button>
            </div>
        `
    })
    salvarRascunho()
}

function editarPorta(id){
    const porta = portas.find(p=>p.id===id)
    if(!porta) return
    editando = id
    document.getElementById("tipologia").value = porta.tipo
    document.getElementById("quantidade").value = porta.quantidade
    renderCampos()
    for(const k in porta.dados){
        const el=document.getElementById(k)
        if(el) el.value = porta.dados[k]
    }
    atualizarPrecoPorta()
    desenharPorta()
}

function apagarPorta(id){
    if(!confirm("Tem certeza que deseja apagar esta porta?")) return
    portas = portas.filter(p=>p.id!==id)
    renderPortas()
}

function salvarRascunho() {
    localStorage.setItem(draftKey, JSON.stringify(portas))
}

function carregarRascunho() {
    const data = localStorage.getItem(draftKey)
    if (!data) return
    try {
        const parsed = JSON.parse(data)
        if (Array.isArray(parsed)) {
            portas = parsed.map((p) => ({ ...p, id: idCounter++ }))
            renderPortas()
        }
    } catch (err) {
        console.error("Erro ao carregar rascunho:", err)
    }
}

// =====================
// FINALIZAR OR√áAMENTO
// =====================
async function finalizarOrcamento(){
    if(portas.length === 0) return alert("Adicione pelo menos uma porta.");

    // Preparar portas com UUID
    const portasComUUID = portas.map(p => ({ ...p, orcamento_uuid: ORCAMENTO_UUID }));

    try{
        // Salvar portas no Supabase
        const resPortas = await fetch(`${API_BASE}/api/orcamento/${ORCAMENTO_UUID}/portas`, {
            method: "POST",
            headers: {'Content-Type':'application/json'},
            body: JSON.stringify({ portas: portasComUUID })
        });
        const dataPortas = await resPortas.json();
        if(!dataPortas.success) throw new Error(dataPortas.error || "Erro ao salvar portas");

        alert("Portas salvas com sucesso!");
        localStorage.removeItem(draftKey);
        window.location.href = "/"; // ou mantem na p√°gina se quiser editar mais

    } catch(err){
        console.error(err);
        alert("Erro ao salvar portas: " + err.message);
    }
}


// =====================
// CARREGAR PORTAS EXISTENTES
// =====================
async function carregarPortas(){
    try{
        const res = await fetch(`${API_BASE}/api/orcamento/${ORCAMENTO_UUID}/portas`)
        const data = await res.json()
        if(data.success && data.portas){
            portas = data.portas.map((p) => ({ ...p, id: idCounter++ }))
            renderPortas()
            localStorage.removeItem(draftKey)
        }
    } catch(err){
        console.error(err)
    }
}

// =====================
// LINK ESTRUTURAS 3D
// =====================    

function abrirEstrutura3D(){
    const url = `3dteste.html?orcamento_uuid=${ORCAMENTO_UUID}`;
    window.open(url, "_blank");
}


// =====================
// CARREGAR ESTRUTURAS 3D SALVAS
// =====================
let estruturas3D = [];

function carregarEstruturas3D() {
    try {
        const data = localStorage.getItem(`estruturas_${ORCAMENTO_UUID}`);
        if (!data) return;
        estruturas3D = JSON.parse(data);
        renderEstruturas3D();
    } catch (err) {
        console.error("Erro ao carregar estruturas 3D:", err);
    }
}

function renderEstruturas3D() {
    const container = document.getElementById("estruturas3DSalvas");
    container.innerHTML = ""; // limpa antes de renderizar
    estruturas3D.forEach((e, idx) => {
        container.innerHTML += `
            <div style="margin-bottom:10px; border:1px solid #333; padding:10px; background:#e0e0e0;">
                <strong>Estrutura 3D ${idx + 1}</strong><br>
                Comprimento total: ${e.totalLength.toFixed(2)} mm<br>
                Fixadores: ${e.fixadores || "Nenhum"}<br>
                <button class="btn" onclick="verEstrutura3D(${idx})">Ver 3D</button>
            </div>
        `;
    });
}


function verEstrutura3D(idx) {
    // Reabrir a estrutura em 3dteste.html passando o √≠ndice
    const url = `3dteste.html?orcamento_uuid=${ORCAMENTO_UUID}&estrutura_idx=${idx}`;
    window.open(url, "_blank");
}


// =====================
carregarPerfis()
carregarVidros()
carregarInsumos()
carregarRascunho()
carregarPortas()
carregarEstruturas3D()
</script>
</body>
</html>







