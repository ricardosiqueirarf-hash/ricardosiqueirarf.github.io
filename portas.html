<!DOCTYPE html>
<html lang="pt-br">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Portas de Vidro e Alum√≠nio em Fortaleza | ColorGlass</title>
<meta name="description" content="Portas de vidro e alum√≠nio sob medida em Fortaleza. Or√ßamento r√°pido, qualidade premium e instala√ß√£o profissional.">
<meta name="robots" content="index, follow">

<!-- SEO LOCAL -->
<meta name="geo.region" content="BR-CE">
<meta name="geo.placename" content="Fortaleza">
<meta name="geo.position" content="-3.7319;-38.5267">
<meta name="ICBM" content="-3.7319, -38.5267">

<!-- CANONICAL -->
<link rel="canonical" href="https://www.colorglassfortaleza.com.br/">

<!-- OPEN GRAPH -->
<meta property="og:title" content="Portas de Vidro e Alum√≠nio em Fortaleza | ColorGlass">
<meta property="og:description" content="Or√ßamento r√°pido em portas de vidro e alum√≠nio sob medida em Fortaleza. Qualidade premium e instala√ß√£o profissional.">
<meta property="og:url" content="https://www.colorglassfortaleza.com.br/">
<meta property="og:type" content="website">

<style>
body { margin:0; font-family:Arial, Helvetica, sans-serif; background:#f2f2f2; }
.app { display:grid; grid-template-columns:18% 82%; height:100vh; }
.sidebar { background:#1e1e1e; color:white; padding:20px; display:flex; flex-direction:column; gap:10px; }
.sidebar button { padding:10px; border:none; background:#333; color:white; border-radius:6px; cursor:pointer; }
.content { padding:25px; overflow-y:auto; height:100vh; }
label { display:flex; flex-direction:column; font-size:0.9rem; width:180px; margin-bottom:8px;}
input, select { padding:7px; margin-top:5px; }
.btn { padding:10px 16px; border:none; border-radius:6px; cursor:pointer; background:#0078d7; color:white; margin-top:10px; }
.btn-danger { background:#c0392b; }
#formCliente { background:white; padding:15px; border-radius:8px; margin-bottom:20px; box-shadow:0 2px 8px rgba(0,0,0,.1); }
#portasSalvas div { margin-bottom:10px; border:1px solid #333; padding:10px; background:#f0f0f0; }
table { border-collapse: collapse; width:100%; margin-top:10px; }
th, td { border:1px solid #ccc; padding:5px; text-align:left; }
th { background:#ddd; }
#portaSVG { width:220px; height:400px; border:1px solid #333; margin-top:10px; background:white; }
</style>

<link id="tema-css" rel="stylesheet" href="">
<script>
if(localStorage.getItem("darkmode") === "true"){
    document.getElementById("tema-css").href = "/static/css/indexdark.css";
}
</script>
</head>

<body>
<div class="app">
    <div class="sidebar">
        <h3>ColorGlass</h3>
        <button onclick="go('perfis.html')">Perfis</button>
        <button onclick="go('vidros.html')">Vidros</button>
        <button onclick="go('producao.html')">Produ√ß√£o</button>
        <button onclick="go('insumos.html')">Insumos</button>
        <button onclick="go('catalogo.html')">Cat√°logo</button>
        <button onclick="go('ajustes.html')">Ajustes</button>
    </div>

    <div class="content">
        <h1>Or√ßamento de Portas</h1>

        <div id="infoOrcamento" style="margin-bottom:15px;"></div>

        <label>Tipologia
            <select id="tipologia" onchange="renderCampos()">
                <option value="">Selecione</option>
                <option value="giro">Giro</option>
                <option value="deslizante">Deslizante</option>
                <option value="correr">Correr</option>
                <option value="pivotante">Pivotante</option>
            </select>
        </label>

        <button class="btn" onclick="abrirEstrutura3D()" style="margin-top:10px;">
    üß± Or√ßar Estrutura 3D
        </button>

        <label>Quantidade<input type="number" id="quantidade" value="1" min="1" onchange="atualizarPrecoPorta()"></label>

        <div id="campos"></div>
        <svg id="portaSVG"></svg>

        <button class="btn" onclick="salvarPorta()">Salvar Porta</button>

        <h2>Portas Salvas</h2>
        <div id="portasSalvas"></div>

        <button class="btn" onclick="finalizarOrcamento()" style="margin-top:20px;">
            Finalizar Or√ßamento
        </button>
    </div>
</div>

<script>
function go(p){ window.location.href = p }

// =====================
// BACKEND
// =====================
const API_BASE = "https://colorglass.onrender.com";

// =====================
// UUID DO OR√áAMENTO
// =====================
const params = new URLSearchParams(window.location.search)
const ORCAMENTO_UUID = params.get("orcamento_uuid")
if(!ORCAMENTO_UUID){
    document.getElementById("infoOrcamento").innerHTML =
        "<strong style='color:red'>UUID do or√ßamento n√£o encontrado</strong>"
    throw new Error("orcamento_uuid ausente")
}
document.getElementById("infoOrcamento").innerHTML =
    `Editando or√ßamento: <strong>${ORCAMENTO_UUID}</strong>`

// =====================
// TIPOLOGIAS
// =====================
const TIPOLOGIAS = {
    giro: ["largura","altura","perfil","vidro","dobradica"],
    deslizante: ["largura","altura","perfil","vidro","trilho"],
    correr: ["largura","altura","perfil","vidro","trilho"],
    pivotante: ["largura","altura","perfil","vidro","pivo"]
}

// =====================
// DADOS
// =====================
let todosPerfis = []
let todosVidros = []

async function carregarPerfis() {
    const res = await fetch(`${API_BASE}/api/perfis`)
    todosPerfis = await res.json()
    atualizarPerfisSelect()
}

async function carregarVidros() {
    const res = await fetch(`${API_BASE}/api/vidros`)
    todosVidros = await res.json()
    atualizarVidrosSelect()
}

function atualizarPerfisSelect() {
    const tipo = document.getElementById("tipologia").value
    const perfilSelect = document.getElementById("perfil")
    if(!perfilSelect) return
    perfilSelect.innerHTML = "<option value=''>Selecione</option>"
    todosPerfis.filter(p => p.tipologias.includes(tipo))
        .forEach(p => {
            perfilSelect.innerHTML += `<option value="${p.id}">${p.nome} - R$ ${p.preco}/m</option>`
        })
}

function atualizarVidrosSelect() {
    const vidroSelect = document.getElementById("vidro")
    if(!vidroSelect) return
    vidroSelect.innerHTML = "<option value=''>Selecione</option>"
    todosVidros.forEach(v => {
        vidroSelect.innerHTML += `<option value="${v.id}">${v.tipo} ${v.espessura || ""}mm - R$ ${v.preco}/m¬≤</option>`
    })
}

// =====================
// PRE√áO
// =====================
function calcularPrecoPorta(){
    const largura = (+document.getElementById("largura")?.value || 0)/1000
    const altura = (+document.getElementById("altura")?.value || 0)/1000
    const perfil = todosPerfis.find(p=>p.id==document.getElementById("perfil")?.value)
    const vidro = todosVidros.find(v=>v.id==document.getElementById("vidro")?.value)
    const quantidade = +document.getElementById("quantidade")?.value || 1

    let total = 0
    if(perfil) total += perfil.preco * 2 * (largura + altura)
    if(vidro) total += vidro.preco * largura * altura

    return total * quantidade
}

function atualizarPrecoPorta(){
    const preco = calcularPrecoPorta()
    document.getElementById("precoPorta")?.remove()
    document.getElementById("campos").insertAdjacentHTML(
        "beforeend",
        `<div id="precoPorta"><strong>Pre√ßo estimado: R$ ${preco.toFixed(2)}</strong></div>`
    )
}

// =====================
// RENDER CAMPOS
// =====================
function renderCampos(){
    const tipo = document.getElementById("tipologia").value
    const container = document.getElementById("campos")
    container.innerHTML=""
    if(!TIPOLOGIAS[tipo]) return

    TIPOLOGIAS[tipo].forEach(c=>{
        const map={
            largura:`Largura (mm)<input id="largura" type="number" value="800" oninput="desenharPorta(); atualizarPrecoPorta()">`,
            altura:`Altura (mm)<input id="altura" type="number" value="2000" oninput="desenharPorta(); atualizarPrecoPorta()">`,
            perfil:`Perfil<select id="perfil" onchange="atualizarPrecoPorta()"></select>`,
            vidro:`Vidro<select id="vidro" onchange="atualizarPrecoPorta()"></select>`,
            trilho:`Trilho<select><option>Padr√£o</option></select>`,
            dobradica:`Dobradi√ßa<select><option>Padr√£o</option></select>`,
            pivo:`Piv√¥<select><option>Superior</option></select>`
        }
        container.innerHTML += `<label>${map[c]}</label>`
    })

    desenharPorta()
    atualizarPerfisSelect()
    atualizarVidrosSelect()
    atualizarPrecoPorta()
}

// =====================
// SVG
// =====================
function desenharPorta(){
    const svg = document.getElementById("portaSVG")
    const w = +document.getElementById("largura")?.value
    const h = +document.getElementById("altura")?.value
    if(!w||!h) return
    svg.innerHTML=""
    const scale = Math.min(200/w, 380/h)
    svg.innerHTML = `<rect x="10" y="10" width="${w*scale}" height="${h*scale}" fill="#ccc" stroke="#000" stroke-width="6"/>`
}

// =====================
// PORTAS LOCAL
// =====================
let portas=[], editando=null, idCounter=0

function salvarPorta(){
    const tipo = document.getElementById("tipologia").value
    if(!tipo) return alert("Selecione a tipologia")

    const dados = {}
    TIPOLOGIAS[tipo].forEach(c=>{
        const el = document.getElementById(c)
        if(el) dados[c] = el.value
    })
    const quantidade = +document.getElementById("quantidade")?.value || 1

    const porta = {
        id: editando ?? idCounter++,
        tipo,
        dados,
        quantidade,
        preco: calcularPrecoPorta(),
        svg: portaSVG.outerHTML
    }
    editando === null ? portas.push(porta) : Object.assign(portas.find(p=>p.id===editando), porta)
    editando = null
    renderPortas()
}

function renderPortas(){
    const c = document.getElementById("portasSalvas")
    c.innerHTML = ""
    portas.forEach((p, idx)=>{
        c.innerHTML += `
            <div>
                <strong>${idx+1}. ${p.tipo}</strong><br>
                Quantidade: ${p.quantidade}<br>
                Pre√ßo: R$ ${p.preco.toFixed(2)}<br>
                ${p.svg}<br>
                <button class="btn" onclick="editarPorta(${p.id})">Editar</button>
                <button class="btn btn-danger" onclick="apagarPorta(${p.id})">Apagar</button>
            </div>
        `
    })
}

function editarPorta(id){
    const porta = portas.find(p=>p.id===id)
    if(!porta) return
    editando = id
    document.getElementById("tipologia").value = porta.tipo
    document.getElementById("quantidade").value = porta.quantidade
    renderCampos()
    for(const k in porta.dados){
        const el=document.getElementById(k)
        if(el) el.value = porta.dados[k]
    }
    atualizarPrecoPorta()
    desenharPorta()
}

function apagarPorta(id){
    if(!confirm("Tem certeza que deseja apagar esta porta?")) return
    portas = portas.filter(p=>p.id!==id)
    renderPortas()
}

// =====================
// FINALIZAR OR√áAMENTO
// =====================
async function finalizarOrcamento(){
    if(portas.length === 0) return alert("Adicione pelo menos uma porta.");

    // Preparar portas com UUID
    const portasComUUID = portas.map(p => ({ ...p, orcamento_uuid: ORCAMENTO_UUID }));

    try{
        // Salvar portas no Supabase
        const resPortas = await fetch(`${API_BASE}/api/orcamento/${ORCAMENTO_UUID}/portas`, {
            method: "POST",
            headers: {'Content-Type':'application/json'},
            body: JSON.stringify({ portas: portasComUUID })
        });
        const dataPortas = await resPortas.json();
        if(!dataPortas.success) throw new Error(dataPortas.error || "Erro ao salvar portas");

        alert("Portas salvas com sucesso!");
        window.location.href = "/"; // ou mantem na p√°gina se quiser editar mais

    } catch(err){
        console.error(err);
        alert("Erro ao salvar portas: " + err.message);
    }
}


// =====================
// CARREGAR PORTAS EXISTENTES
// =====================
async function carregarPortas(){
    try{
        const res = await fetch(`${API_BASE}/api/orcamento/${ORCAMENTO_UUID}/portas`)
        const data = await res.json()
        if(data.success && data.portas){
            portas = data.portas.map((p, idx) => ({ ...p, id: idCounter++ }))
            renderPortas()
        }
    } catch(err){
        console.error(err)
    }
}

// =====================
// LINK ESTRUTURAS 3D
// =====================    

function abrirEstrutura3D(){
    const url = `3dteste.html?orcamento_uuid=${ORCAMENTO_UUID}`;
    window.open(url, "_blank");
}


// =====================
// CARREGAR ESTRUTURAS 3D SALVAS
// =====================
let estruturas3D = [];

function carregarEstruturas3D() {
    try {
        const data = localStorage.getItem(`estruturas_${ORCAMENTO_UUID}`);
        if (!data) return;
        estruturas3D = JSON.parse(data);
        renderEstruturas3D();
    } catch (err) {
        console.error("Erro ao carregar estruturas 3D:", err);
    }
}

function renderEstruturas3D() {
    const container = document.getElementById("portasSalvas");
    estruturas3D.forEach((e, idx) => {
        container.innerHTML += `
            <div style="margin-bottom:10px; border:1px solid #333; padding:10px; background:#e0e0e0;">
                <strong>Estrutura 3D ${idx + 1}</strong><br>
                Total de linhas: ${e.history.length}<br>
                Fixadores: ${e.fixadores || "Nenhum"}<br>
                <button class="btn" onclick="verEstrutura3D(${idx})">Ver 3D</button>
            </div>
        `;
    });
}


function verEstrutura3D(idx) {
    // Reabrir a estrutura em 3dteste.html passando o √≠ndice
    const url = `3dteste.html?orcamento_uuid=${ORCAMENTO_UUID}&estrutura_idx=${idx}`;
    window.open(url, "_blank");
}


// =====================
carregarPerfis()
carregarVidros()
carregarPortas()
carregarEstruturas3D()
</script>
</body>
</html>





